<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U.O.P.I. - IPRP 8.0</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/B6E4u1X.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* ========== DESIGN SYSTEM PROFESSIONALE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-app: #0a0e1a;
            --bg-card: rgba(30, 41, 59, 0.6);
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.12);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-accent: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --shadow-glow: 0 0 30px rgba(59, 130, 246, 0.3);
            --shadow-card: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* Animated background particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            animation: backgroundShift 20s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        /* ========== HEADER ========== */
        .header {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(24px);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 3rem;
            height: 3rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-glow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: logoFloat 3s ease-in-out infinite;
        }

        .logo:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.6);
        }

        .logo-right {
            margin-left: auto;
            margin-right: 0;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .brand h1 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .brand p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .nav {
            display: flex;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.08);
            padding: 0.5rem;
            border-radius: 1rem;
        }

        .nav-btn {
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            border-radius: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-btn:hover::before {
            left: 100%;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            border: 1px solid var(--border);
            position: relative;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-1px);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(24px);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 0.5rem;
            min-width: 200px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .user-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .dropdown-item.logout {
            color: #ef4444;
        }

        .dropdown-item.logout:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Sistema Notifiche Migliorato */
        .notifications-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 420px;
            pointer-events: none;
        }

        .notification {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.95));
            backdrop-filter: blur(32px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1.25rem;
            padding: 1.5rem;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            opacity: 0;
            transform: translateX(500px) scale(0.8);
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
            pointer-events: auto;
            min-height: 80px;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0) scale(1);
        }

        .notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .notification.show::before {
            opacity: 1;
        }

        .notification.success {
            border-left: 4px solid #10b981;
        }

        .notification.success::before {
            background: linear-gradient(90deg, transparent, #10b981, transparent);
        }

        .notification.error {
            border-left: 4px solid #ef4444;
        }

        .notification.error::before {
            background: linear-gradient(90deg, transparent, #ef4444, transparent);
        }

        .notification.info {
            border-left: 4px solid #3b82f6;
        }

        .notification.info::before {
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
        }

        .notification.warning {
            border-left: 4px solid #f59e0b;
        }

        .notification.warning::before {
            background: linear-gradient(90deg, transparent, #f59e0b, transparent);
        }

        .notification-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            gap: 1rem;
        }

        .notification-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .notification.success .notification-icon {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3));
            color: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .notification.error .notification-icon {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.3));
            color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }

        .notification.info .notification-icon {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.3));
            color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .notification.warning .notification-icon {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.3));
            color: #f59e0b;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }

        .notification-content-wrapper {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 0.25rem;
            line-height: 1.3;
        }

        .notification-content {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }

        .notification-time {
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 500;
            opacity: 0.8;
        }

        .notification-close {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-close:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            transform: scale(1.05);
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 0 0 1.25rem 1.25rem;
            transition: width linear;
        }

        .notification.success .notification-progress {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .notification.error .notification-progress {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .notification.info .notification-progress {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }

        .notification.warning .notification-progress {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        /* Animazioni di hover per le notifiche */
        .notification:hover {
            transform: translateX(-5px) scale(1.02);
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        /* Scrollbar personalizzata */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.6), rgba(139, 92, 246, 0.6));
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(139, 92, 246, 0.8));
        }

        ::-webkit-scrollbar-corner {
            background: rgba(30, 41, 59, 0.3);
        }

        /* Scrollbar per Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(59, 130, 246, 0.6) rgba(30, 41, 59, 0.3);
        }

        /* Custom Dropdown Styles */
        .custom-dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .dropdown-trigger {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .dropdown-trigger:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .dropdown-trigger:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .dropdown-trigger::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .dropdown-trigger:hover::before {
            left: 100%;
        }

        .dropdown-text {
            flex: 1;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-arrow {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .dropdown-trigger.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.98));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            z-index: 1000;
            margin-top: 0.5rem;
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .dropdown-menu.show {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05));
            color: #e2e8f0;
            transform: translateX(4px);
        }

        .dropdown-item.selected {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
            color: #10b981;
            font-weight: 600;
        }

        .dropdown-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            transform: scaleY(0);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dropdown-item:hover::before {
            transform: scaleY(1);
        }

        .dropdown-item.selected::before {
            background: linear-gradient(135deg, #10b981, #059669);
            transform: scaleY(1);
        }

        .dropdown-item-icon {
            font-size: 1rem;
            min-width: 1rem;
            text-align: center;
        }

        .dropdown-item-text {
            flex: 1;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .dropdown-item-qualification {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.125rem;
        }

        /* Custom Scrollbar for Dropdown */
        .dropdown-menu::-webkit-scrollbar {
            width: 6px;
        }

        .dropdown-menu::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 3px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
        }

        /* Focus and Active States */
        .dropdown-trigger:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .dropdown-item:focus {
            outline: none;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.1));
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dropdown-menu {
                max-height: 250px;
            }
            
            .dropdown-item {
                padding: 0.625rem 0.875rem;
            }
            
            .dropdown-item-text {
                font-size: 0.8125rem;
            }
        }

        /* Dropdown Styling Fix - Migliorato */
        select {
            background: #1e293b !important;
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
            border: 1px solid #334155 !important;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e2e8f0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2.5rem !important;
            font-size: 1rem !important;
            font-weight: 500 !important;
        }
        
        select option {
            background: #1e293b !important;
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
            padding: 0.75rem !important;
            font-size: 1rem !important;
            font-weight: 500 !important;
            border: none !important;
        }
        
        select option:hover {
            background: #334155 !important;
            background-color: #334155 !important;
        }
        
        select option:checked {
            background: #3b82f6 !important;
            background-color: #3b82f6 !important;
            color: white !important;
        }
        
        select:focus {
            background: #1e293b !important;
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
            outline: none !important;
        }
        
        select:hover {
            background: #334155 !important;
            background-color: #334155 !important;
            border-color: #475569 !important;
        }
        
        /* Forza il tema scuro per tutti i browser */
        select::-ms-expand {
            display: none;
        }
        
        /* Firefox specific */
        @-moz-document url-prefix() {
            select {
                background: #1e293b !important;
                background-color: #1e293b !important;
                color: #e2e8f0 !important;
            }
            
            select option {
                background: #1e293b !important;
                background-color: #1e293b !important;
                color: #e2e8f0 !important;
            }
        }

        /* Separazione Gerarchica Nuclei */
        .nuclei-separator {
            position: relative;
            margin: 1.5rem 0;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .nuclei-separator::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            border-radius: 1rem 1rem 0 0;
        }

        .nuclei-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 1.125rem;
            font-weight: 700;
        }

        .nuclei-title.dirigenziale {
            color: #ef4444;
        }

        .nuclei-title.amministrativo {
            color: #10b981;
        }

        .nuclei-title.operativo {
            color: #3b82f6;
        }

        .nuclei-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .nuclei-icon.dirigenziale {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.3));
            color: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        .nuclei-icon.amministrativo {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3));
            color: #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }

        .nuclei-icon.operativo {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.3));
            color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        .nuclei-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }

        .nuclei-stats {
            display: flex;
            gap: 1rem;
            margin-top: 0.75rem;
        }

        .nuclei-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            font-size: 0.8125rem;
            font-weight: 600;
        }

        .nuclei-stat.dirigenziale {
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .nuclei-stat.amministrativo {
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .nuclei-stat.operativo {
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        /* Divisione Gerarchica Avanzata */
        .hierarchical-section {
            margin: 2rem 0;
            position: relative;
        }

        .hierarchical-section::before {
            content: '';
            position: absolute;
            top: -1rem;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.3;
        }

        .hierarchical-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
            border-radius: 1rem 1rem 0 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: none;
            position: relative;
            overflow: hidden;
        }

        .hierarchical-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
        }

        .hierarchical-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.5rem;
            font-weight: 800;
        }

        .hierarchical-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            position: relative;
        }

        .hierarchical-icon::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 1rem;
            padding: 2px;
            background: linear-gradient(45deg, currentColor, transparent, currentColor);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            opacity: 0.3;
        }

        .hierarchical-icon.dirigenziale {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.3));
            color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        .hierarchical-icon.amministrativo {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3));
            color: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }

        .hierarchical-icon.operativo {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.3));
            color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        }

        .hierarchical-stats {
            display: flex;
            gap: 1.5rem;
        }

        .hierarchical-stat {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            font-size: 0.9375rem;
            font-weight: 700;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hierarchical-stat.dirigenziale {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .hierarchical-stat.amministrativo {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .hierarchical-stat.operativo {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .hierarchical-content {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
            border-radius: 0 0 1rem 1rem;
            padding: 0;
            backdrop-filter: blur(24px);
        }

        .hierarchical-description {
            padding: 1.5rem 2rem;
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.6;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-style: italic;
        }

        .hierarchical-table {
            background: transparent;
            border: none;
            border-radius: 0;
            margin: 0;
            box-shadow: none;
        }

        .hierarchical-table table {
            background: transparent;
        }

        .hierarchical-table th {
            background: rgba(255, 255, 255, 0.05);
            font-size: 0.875rem;
            padding: 1rem 1.5rem;
        }

        .hierarchical-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .hierarchical-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Priorità Gerarchica */
        .hierarchical-section.dirigenziale {
            z-index: 3;
        }

        .hierarchical-section.amministrativo {
            z-index: 2;
        }

        .hierarchical-section.operativo {
            z-index: 1;
        }

        /* Animazioni Gerarchiche */
        .hierarchical-section {
            opacity: 0;
            transform: translateY(30px);
            animation: hierarchicalFadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .hierarchical-section.dirigenziale {
            animation-delay: 0.1s;
        }

        .hierarchical-section.amministrativo {
            animation-delay: 0.3s;
        }

        .hierarchical-section.operativo {
            animation-delay: 0.5s;
        }

        @keyframes hierarchicalFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.75rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
        }

        /* ========== MAIN CONTENT ========== */
        .main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .page-header {
            margin-bottom: 3rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: var(--text-muted);
            font-size: 1.125rem;
        }

        .actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* ========== BUTTONS ========== */
        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.5);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-success::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-success:hover::before {
            left: 100%;
        }

        .btn-success:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.5);
        }

        /* ========== GRID ========== */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        /* ========== CARDS ========== */
        .card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(24px);
            border: 1px solid var(--border);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: translateY(30px);
            animation: cardFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-card);
            border-color: rgba(59, 130, 246, 0.4);
        }

        @keyframes cardFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }
        .card:nth-child(3) { animation-delay: 0.3s; }
        .card:nth-child(4) { animation-delay: 0.4s; }

        .stat-card {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .stat-icon {
            width: 4rem;
            height: 4rem;
            border-radius: 1rem;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            color: white;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: iconPulse 2s ease-in-out infinite;
        }

        .stat-icon:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.5);
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .stat-content h3 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        /* ========== TABLE ========== */
        .table-container {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border);
            border-radius: 1.5rem;
            overflow: hidden;
            backdrop-filter: blur(24px);
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            animation-delay: 0.3s;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1.25rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: scale(1.01);
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .nav {
                width: 100%;
                overflow-x: auto;
            }

            .main {
                padding: 2rem 1rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- LOGIN -->
        <div id="loginPage" style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
            <div style="background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 2rem; padding: 3rem; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);">
                <img src="https://i.imgur.com/B6E4u1X.png" alt="Logo" style="width: 120px; height: 120px; margin: 0 auto 2rem; border-radius: 50%; box-shadow: 0 0 30px rgba(59, 130, 246, 0.4);">
                <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem;">U.O.P.I.</h1>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Unità Operativa di Primo Intervento</p>
                <button onclick="loginWithDiscord()" style="width: 100%; padding: 1.25rem; background: linear-gradient(135deg, #5865f2, #4752c4); border: none; border-radius: 1rem; color: white; font-weight: 700; font-size: 1.125rem; cursor: pointer; box-shadow: 0 8px 20px rgba(88, 101, 242, 0.4); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 30px rgba(88, 101, 242, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(88, 101, 242, 0.4)'">
                    <i class="fab fa-discord"></i> Accedi con Discord
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURAZIONE ==========
        const CLIENT_ID = '1387801645743869982';
        const REDIRECT_URI = 'https://ryze-glitch.github.io/uopi-dashboard/';
        const ADMIN_ID = '1387684968536477756';

        // ========== VARIABILI GLOBALI ==========
        let operators = [];
        let notifications = [];
        let shifts = [];

        // ========== SISTEMA NOTIFICHE ==========

        // ========== SISTEMA DI PERSISTENZA DATI ==========
        const STORAGE_KEYS = {
            OPERATORS: 'uopi_operators',
            NOTIFICATIONS: 'uopi_notifications',
            SHIFTS: 'uopi_shifts',
            SETTINGS: 'uopi_settings'
        };

        // Funzioni di gestione localStorage
        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Errore nel salvataggio dati:', error);
                UI.notify('⚠️ Errore nel salvataggio dati!', 'error', '❌ Errore Storage');
                return false;
            }
        }

        function loadFromStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error('Errore nel caricamento dati:', error);
                UI.notify('⚠️ Errore nel caricamento dati!', 'error', '❌ Errore Storage');
                return defaultValue;
            }
        }

        function clearStorage(key) {
            try {
                localStorage.removeItem(key);
                return true;
            } catch (error) {
                console.error('Errore nella cancellazione dati:', error);
                return false;
            }
        }

        // Funzioni specifiche per operatori
        function saveOperators() {
            return saveToStorage(STORAGE_KEYS.OPERATORS, operators);
        }

        function loadOperators() {
            const savedOperators = loadFromStorage(STORAGE_KEYS.OPERATORS, []);
            if (savedOperators && Array.isArray(savedOperators)) {
                operators = savedOperators;
                return true;
            }
            return false;
        }

        function clearOperatorsStorage() {
            return clearStorage(STORAGE_KEYS.OPERATORS);
        }

        // Funzioni per notifiche
        function saveNotifications() {
            return saveToStorage(STORAGE_KEYS.NOTIFICATIONS, notifications);
        }

        function loadNotifications() {
            const savedNotifications = loadFromStorage(STORAGE_KEYS.NOTIFICATIONS, []);
            if (savedNotifications && Array.isArray(savedNotifications)) {
                notifications = savedNotifications;
                return true;
            }
            return false;
        }

        // Funzioni per turni
        function saveShifts() {
            return saveToStorage(STORAGE_KEYS.SHIFTS, shifts);
        }

        function loadShifts() {
            const savedShifts = loadFromStorage(STORAGE_KEYS.SHIFTS, []);
            if (savedShifts && Array.isArray(savedShifts)) {
                shifts = savedShifts;
                return true;
            }
            return false;
        }

        // Funzione di backup completo
        function createBackup() {
            const backup = {
                operators: operators,
                notifications: notifications,
                shifts: shifts,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const backupData = JSON.stringify(backup, null, 2);
            const blob = new Blob([backupData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `uopi_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            UI.notify('✅ Backup creato con successo!', 'success', '💾 Backup Completato');
        }

        // Funzione di ripristino da backup
        function restoreFromBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backup = JSON.parse(e.target.result);
                        
                        if (backup.operators && Array.isArray(backup.operators)) {
                            operators = backup.operators;
                            saveOperators();
                        }
                        
                        if (backup.notifications && Array.isArray(backup.notifications)) {
                            notifications = backup.notifications;
                            saveNotifications();
                        }
                        
                        if (backup.shifts && Array.isArray(backup.shifts)) {
                            shifts = backup.shifts;
                            saveShifts();
                        }
                        
                        UI.notify('✅ Backup ripristinato con successo!', 'success', '🔄 Ripristino Completato');
                        loadPage('personnel');
                        updateOverviewStats();
                        
                    } catch (error) {
                        console.error('Errore nel ripristino:', error);
                        UI.notify('⚠️ File di backup non valido!', 'error', '❌ Errore Ripristino');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ========== SISTEMA UNIVERSALE ==========
        const UI = {
            // MODAL
            modal(title, content, footer) {
                const existing = document.querySelector('.universal-modal');
                if (existing) existing.remove();
                
                const modal = document.createElement('div');
                modal.className = 'universal-modal';
                modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;z-index:99999;opacity:0;transition:opacity 0.3s';
                
                modal.innerHTML = `
                    <div style="background:linear-gradient(135deg,rgba(30,41,59,0.95),rgba(30,41,59,0.9));backdrop-filter:blur(24px);border:1px solid rgba(255,255,255,0.12);border-radius:1.5rem;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.4)">
                        <div style="display:flex;align-items:center;justify-content:space-between;padding:1.5rem 2rem;border-bottom:1px solid rgba(255,255,255,0.12)">
                            <h3 style="font-size:1.5rem;font-weight:700;color:#fff;margin:0">${title}</h3>
                            <button onclick="UI.closeModal()" style="width:2rem;height:2rem;border-radius:0.5rem;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s" onmouseover="this.style.background='#ef4444'" onmouseout="this.style.background='rgba(255,255,255,0.08)'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="padding:2rem">${content}</div>
                        ${footer ? `<div style="display:flex;gap:1rem;justify-content:flex-end;padding:1.5rem 2rem;border-top:1px solid rgba(255,255,255,0.12)">${footer}</div>` : ''}
                    </div>
                `;
                
                document.body.appendChild(modal);
                setTimeout(() => modal.style.opacity = '1', 10);
                modal.onclick = e => { if (e.target === modal) this.closeModal(); };
            },
            
            closeModal() {
                const modal = document.querySelector('.universal-modal');
                if (modal) {
                    modal.style.opacity = '0';
                    setTimeout(() => modal.remove(), 300);
                }
            },
            
            // NOTIFICHE AVANZATE
            notify(message, type = 'success', title = '', duration = 5000) {
                const notificationId = Date.now();
                const timestamp = new Date();
                
                const notification = {
                    id: notificationId,
                    message: message,
                    type: type,
                    title: title || this.getNotificationTitle(type),
                    timestamp: timestamp,
                    duration: duration
                };
                
                notifications.push(notification);
                this.renderNotification(notification);
                
                // Auto-remove dopo la durata specificata
                setTimeout(() => {
                    this.removeNotification(notificationId);
                }, duration);
            },

            getNotificationTitle(type) {
                const titles = {
                    success: '✅ Successo',
                    error: '❌ Errore',
                    info: 'ℹ️ Informazione',
                    warning: '⚠️ Avviso'
                };
                return titles[type] || '📢 Notifica';
            },

            renderNotification(notification) {
                const container = this.getNotificationsContainer();
                
                const notificationEl = document.createElement('div');
                notificationEl.className = `notification ${notification.type}`;
                notificationEl.setAttribute('data-id', notification.id);
                
                const timeAgo = this.getTimeAgo(notification.timestamp);
                
                notificationEl.innerHTML = `
                    <div class="notification-header">
                        <div class="notification-icon">
                            <i class="fas fa-${this.getNotificationIcon(notification.type)}"></i>
                        </div>
                        <div class="notification-content-wrapper">
                            <div class="notification-title">${notification.title}</div>
                            <div class="notification-content">${notification.message}</div>
                            <div class="notification-time">${timeAgo}</div>
                        </div>
                        <button class="notification-close" onclick="UI.removeNotification(${notification.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="notification-progress" style="width: 100%;"></div>
                `;
                
                container.appendChild(notificationEl);
                
                // Animazione di entrata
                setTimeout(() => {
                    notificationEl.classList.add('show');
                    
                    // Animazione barra di progresso
                    const progressBar = notificationEl.querySelector('.notification-progress');
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                        progressBar.style.transition = `width ${notification.duration}ms linear`;
                    }, 100);
                }, 10);
            },

            getNotificationIcon(type) {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-triangle',
                    info: 'info-circle',
                    warning: 'exclamation-circle'
                };
                return icons[type] || 'bell';
            },

            getNotificationsContainer() {
                let container = document.querySelector('.notifications-container');
                if (!container) {
                    container = document.createElement('div');
                    container.className = 'notifications-container';
                    document.body.appendChild(container);
                }
                return container;
            },

            removeNotification(notificationId) {
                const notificationEl = document.querySelector(`[data-id="${notificationId}"]`);
                if (notificationEl) {
                    // Animazione di uscita più fluida
                    notificationEl.style.transform = 'translateX(500px) scale(0.8)';
                    notificationEl.style.opacity = '0';
                    
                setTimeout(() => {
                        notificationEl.remove();
                    }, 600);
                }
                
                // Rimuovi dall'array
                notifications = notifications.filter(n => n.id !== notificationId);
            },

            getTimeAgo(timestamp) {
                const now = new Date();
                const diff = now - timestamp;
                const seconds = Math.floor(diff / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                
                if (seconds < 60) return 'Ora';
                if (minutes < 60) return minutes + 'm fa';
                if (hours < 24) return hours + 'h fa';
                return timestamp.toLocaleDateString('it-IT');
            },
            
            // LOADING
            loading(text = 'Caricamento...', show = true) {
                const existing = document.querySelector('.loading-overlay');
                if (existing) existing.remove();
                
                if (!show) return;
                
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:999998;opacity:0;transition:opacity 0.3s';
                
                overlay.innerHTML = `
                    <div style="background:linear-gradient(135deg,rgba(30,41,59,0.95),rgba(30,41,59,0.9));backdrop-filter:blur(24px);border:1px solid rgba(255,255,255,0.12);border-radius:1.5rem;padding:2.5rem;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,0.4);min-width:320px">
                        <div style="width:4rem;height:4rem;border:3px solid rgba(255,255,255,0.1);border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1.5rem"></div>
                        <div style="font-size:1.125rem;font-weight:600;color:#fff">${text}</div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                setTimeout(() => overlay.style.opacity = '1', 10);
            }
        };

        // ========== LOGIN ==========
        function loginWithDiscord() {
            UI.loading('Reindirizzamento...', true);
            setTimeout(() => {
                const url = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`;
                window.location.href = url;
            }, 500);
        }

        // ========== DASHBOARD ==========
        function showDashboard(user) {
            document.getElementById('app').innerHTML = `
                <!-- HEADER -->
                <header class="header">
                    <div class="logo-section">
                        <img src="https://i.imgur.com/B6E4u1X.png" alt="Logo" class="logo">
                        <div class="brand">
                            <h1>U.O.P.I. - IPRP 8.0</h1>
                            <p>Unità Operativa di Primo Intervento</p>
                        </div>
                        <img src="https://i.imgur.com/KIicYcC.png" alt="IPRP Logo" class="logo logo-right">
                    </div>
                    <nav class="nav">
                        <button class="nav-btn active" onclick="loadPage('overview')">📊 Panoramica</button>
                        <button class="nav-btn" onclick="loadPage('personnel')">🏅 Gerarchia</button>
                        <button class="nav-btn" onclick="loadPage('shifts')">🕐 Turni</button>
                        <button class="nav-btn" onclick="loadPage('operations')">🚁 Operazioni</button>
                        <button class="nav-btn" onclick="loadPage('credits')">🔰 Crediti</button>
                    </nav>
                    <div class="user-profile" onclick="toggleUserDropdown()">
                        <div class="avatar">${user.username[0]}</div>
                        <div>
                            <div style="font-weight:600;font-size:0.875rem">${user.username}</div>
                            <div style="font-size:0.75rem;color:#94a3b8">#${user.discriminator}</div>
                        </div>
                        <i class="fas fa-chevron-down" style="font-size:0.75rem;color:#94a3b8;transition:transform 0.3s ease"></i>
                        <div class="user-dropdown">
                            <div class="dropdown-item" onclick="showUserProfile()">
                                <i class="fas fa-user"></i>
                                <span>Profilo</span>
                            </div>
                            <div class="dropdown-item" onclick="showSettings()">
                                <i class="fas fa-cog"></i>
                                <span>Impostazioni</span>
                            </div>
                            <div class="dropdown-item logout" onclick="confirmLogout()">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- MAIN CONTENT -->
                <main class="main" id="mainContent">
                    <!-- Contenuto caricato dinamicamente -->
                </main>
            `;
            
            loadPage('overview');
        }

        // ========== SISTEMA LOGOUT ==========
        function toggleUserDropdown() {
            const dropdown = document.querySelector('.user-dropdown');
            const chevron = document.querySelector('.user-profile i.fa-chevron-down');
            
            if (dropdown.classList.contains('active')) {
                dropdown.classList.remove('active');
                chevron.style.transform = 'rotate(0deg)';
            } else {
                dropdown.classList.add('active');
                chevron.style.transform = 'rotate(180deg)';
            }
        }

        function showUserProfile() {
            UI.closeModal();
            UI.notify('Funzionalità profilo in sviluppo', 'info', '👤 Profilo Utente');
        }

        function showSettings() {
            UI.closeModal();
            UI.notify('Funzionalità impostazioni in sviluppo', 'info', '⚙️ Impostazioni');
        }

        function confirmLogout() {
            UI.closeModal();
            
            const confirmContent = `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem; color: #ef4444;">🚪</div>
                    <h3 style="color: #fff; margin-bottom: 1rem;">Conferma Logout</h3>
                    <p style="color: #94a3b8; margin-bottom: 1.5rem;">Sei sicuro di voler disconnetterti dal sistema U.O.P.I.?</p>
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="color: #ef4444; font-weight: 600; margin-bottom: 0.5rem;">⚠️ Attenzione:</div>
                        <div style="color: #e2e8f0; font-size: 0.875rem;">
                            <div>• Dovrai effettuare nuovamente il login</div>
                            <div>• I dati non salvati potrebbero andare persi</div>
                            <div>• Le notifiche attive verranno chiuse</div>
                        </div>
                    </div>
                </div>
            `;
            
            const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Annulla</button>
                <button class="btn" onclick="performLogout()" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none;">
                    <i class="fas fa-sign-out-alt"></i> Disconnetti
                </button>
            `;
            
            UI.modal('🚪 Logout', confirmContent, footer);
        }

        function performLogout() {
            UI.loading('Disconnessione in corso...', true);
            
            setTimeout(() => {
                // Chiudi tutte le notifiche
                notifications.forEach(notification => {
                    UI.removeNotification(notification.id);
                });
                notifications = [];
                
                // Reset dati
                operators = [];
                
                UI.loading('', false);
                UI.notify('Disconnesso con successo', 'success', '👋 Arrivederci');
                
                setTimeout(() => {
                    // Mostra pagina di login
                    document.getElementById('app').innerHTML = `
                        <div id="loginPage" style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
                            <div style="background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 2rem; padding: 3rem; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);">
                                <img src="https://i.imgur.com/B6E4u1X.png" alt="Logo" style="width: 120px; height: 120px; margin: 0 auto 2rem; border-radius: 50%; box-shadow: 0 0 30px rgba(59, 130, 246, 0.4);">
                                <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem;">U.O.P.I.</h1>
                                <p style="color: #94a3b8; margin-bottom: 2rem;">Unità Operativa di Primo Intervento</p>
                                <button onclick="loginWithDiscord()" style="width: 100%; padding: 1.25rem; background: linear-gradient(135deg, #5865f2, #4752c4); border: none; border-radius: 1rem; color: white; font-weight: 700; font-size: 1.125rem; cursor: pointer; box-shadow: 0 8px 20px rgba(88, 101, 242, 0.4); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 30px rgba(88, 101, 242, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(88, 101, 242, 0.4)'">
                                    <i class="fab fa-discord"></i> Accedi con Discord
                                </button>
                            </div>
                        </div>
                    `;
                }, 1000);
            }, 1500);
        }

        // ========== FUNZIONI UTILITY ==========
        function updateOverviewStats() {
            // Aggiorna automaticamente la panoramica se è attualmente visualizzata
            const currentPage = document.querySelector('.nav-btn.active');
            if (currentPage && currentPage.textContent.includes('Panoramica')) {
                loadPage('overview');
            }
        }

        function testNotifications() {
            // Test sequenziale di tutti i tipi di notifiche
            UI.notify('Operazione completata con successo!', 'success', '✅ Successo', 4000);
            
            setTimeout(() => {
                UI.notify('Si è verificato un errore durante il salvataggio', 'error', '❌ Errore', 5000);
            }, 1000);
            
            setTimeout(() => {
                UI.notify('Nuova versione disponibile per il download', 'info', 'ℹ️ Informazione', 6000);
            }, 2000);
            
            setTimeout(() => {
                UI.notify('Attenzione: memoria quasi piena', 'warning', '⚠️ Avviso', 7000);
            }, 3000);
        }

        function getSystemStats() {
            const totalOperators = operators.length;
            const availableOperators = operators.filter(op => op.status === 'Disponibile').length;
            const activeShifts = 0; // Sarà implementato con i turni
            const efficiency = totalOperators > 0 ? Math.round((availableOperators / totalOperators) * 100) : 0;
            
            return {
                totalOperators,
                availableOperators,
                activeShifts,
                efficiency,
                teamStats: {
                    alpha: operators.filter(op => op.team === 'Alpha').length,
                    beta: operators.filter(op => op.team === 'Beta').length,
                    gamma: operators.filter(op => op.team === 'Gamma').length
                }
            };
        }

        // ========== GESTIONE PAGINE ==========
        function loadPage(page) {
            console.log('📄 Caricamento pagina:', page);
            
            // Aggiorna navigazione
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event?.target?.classList.add('active');
            
            const content = document.getElementById('mainContent');
            
            // Animazione di uscita
            content.style.opacity = '0';
            content.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
            switch(page) {
                case 'overview':
                    content.innerHTML = getOverviewPage();
                    break;
                case 'personnel':
                    content.innerHTML = getPersonnelPage();
                    break;
                case 'shifts':
                    content.innerHTML = getShiftsPage();
                    break;
                case 'operations':
                    content.innerHTML = getOperationsPage();
                    break;
                    case 'credits':
                        content.innerHTML = getCreditsPage();
                    break;
            }
                
                // Animazione di entrata
                content.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                content.style.opacity = '1';
                content.style.transform = 'translateY(0)';
                
                // Animazione delle card
                setTimeout(() => {
                    const cards = content.querySelectorAll('.card');
                    cards.forEach((card, index) => {
                        card.style.animationDelay = `${index * 0.1}s`;
                    });
                }, 100);
            }, 200);
        }

        function getOverviewPage() {
            // Calcola statistiche reali basate sui dati
            const totalOperators = operators.length;
            const availableOperators = operators.filter(op => op.status === 'Disponibile').length;
            const activeShifts = 0; // Sarà implementato quando avremo i turni
            const efficiency = totalOperators > 0 ? Math.round((availableOperators / totalOperators) * 100) : 0;

            return `
                <div class="page-header" style="opacity: 0; animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;">
                    <h1>📊 Panoramica</h1>
                    <p>Monitoraggio in tempo reale delle attività U.O.P.I.</p>
                    <div class="actions">
                        <button class="btn btn-success" onclick="UI.modal('Test Modal', '<p>Modal funziona!</p>', '<button class=\\'btn btn-primary\\' onclick=\\'UI.closeModal()\\'>OK</button>')">
                            🧪 Test Modal
                        </button>
                        <button class="btn btn-primary" onclick="testNotifications()">
                            🔔 Test Notifiche
                        </button>
                    </div>
                </div>

                <div class="grid">
                    <div class="card stat-card">
                        <div class="stat-icon">🚁</div>
                        <div class="stat-content">
                            <h3>0</h3>
                            <div class="stat-label">Operazioni Attive</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">🏅</div>
                        <div class="stat-content">
                            <h3>${totalOperators}</h3>
                            <div class="stat-label">Operatori Totali</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">🕐</div>
                        <div class="stat-content">
                            <h3>${activeShifts}</h3>
                            <div class="stat-label">Turni in Corso</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">📈</div>
                        <div class="stat-content">
                            <h3>${efficiency}%</h3>
                            <div class="stat-label">Disponibilità</div>
                        </div>
                    </div>
                </div>

                ${totalOperators === 0 ? `
                    <div class="card" style="text-align: center; padding: 3rem; margin-top: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">📊</div>
                        <h3 style="color: #e2e8f0; margin-bottom: 1rem;">Sistema Pronto</h3>
                        <p style="color: #94a3b8; margin-bottom: 2rem;">Aggiungi operatori per iniziare a vedere le statistiche reali</p>
                        <button class="btn btn-primary" onclick="loadPage('personnel')">
                            <i class="fas fa-user-plus"></i> Gestisci Operatori
                        </button>
                    </div>
                ` : ''}

                ${totalOperators > 0 ? `
                    <div class="card" style="margin-top: 2rem;">
                        <h3 style="margin-bottom: 1.5rem; color: #e2e8f0;">📋 Riepilogo Operatori</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 0.75rem; padding: 1rem; text-align: center;">
                                <div style="font-size: 2rem; color: #10b981; font-weight: 700;">${availableOperators}</div>
                                <div style="color: #10b981; font-size: 0.875rem; font-weight: 600;">Disponibili</div>
                            </div>
                            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 0.75rem; padding: 1rem; text-align: center;">
                                <div style="font-size: 2rem; color: #3b82f6; font-weight: 700;">${totalOperators - availableOperators}</div>
                                <div style="color: #3b82f6; font-size: 0.875rem; font-weight: 600;">In Servizio</div>
                            </div>
                            <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8b5cf6; border-radius: 0.75rem; padding: 1rem; text-align: center;">
                                <div style="font-size: 2rem; color: #8b5cf6; font-weight: 700;">${operators.filter(op => op.team === 'Alpha').length}</div>
                                <div style="color: #8b5cf6; font-size: 0.875rem; font-weight: 600;">Squadra Alpha</div>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; border-radius: 0.75rem; padding: 1rem; text-align: center;">
                                <div style="font-size: 2rem; color: #f59e0b; font-weight: 700;">${operators.filter(op => op.team === 'Beta').length}</div>
                                <div style="color: #f59e0b; font-size: 0.875rem; font-weight: 600;">Squadra Beta</div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function getPersonnelPage() {
            // Raggruppa operatori per nucleo
            const dirigenzialeOps = operators.filter(op => op.role === 'dirigenziale');
            const amministrativoOps = operators.filter(op => op.role === 'amministrativo');
            const operativoOps = operators.filter(op => op.role === 'operativo');

            // Funzione per creare le righe degli operatori
            const createOperatorRows = (operatorsList) => {
                return operatorsList.map(operator => {
                    const statusColor = operator.status === 'Disponibile' ? '#10b981' : '#3b82f6';
                    const statusBg = operator.status === 'Disponibile' ? '#10b98120' : '#3b82f620';
                    
                    // Colori per i ruoli basati sul nucleo
                    const roleColors = {
                        'dirigenziale': { color: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)', border: 'rgba(239, 68, 68, 0.3)' },
                        'amministrativo': { color: '#10b981', bg: 'rgba(16, 185, 129, 0.1)', border: 'rgba(16, 185, 129, 0.3)' },
                        'operativo': { color: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)', border: 'rgba(59, 130, 246, 0.3)' }
                    };
                    
                    const roleStyle = roleColors[operator.role] || { color: '#94a3b8', bg: 'rgba(148, 163, 184, 0.1)', border: 'rgba(148, 163, 184, 0.3)' };
                    
            return `
                        <tr>
                            <td>
                                <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                    <strong style="color: var(--text-primary);">${operator.name}</strong>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">${operator.discordTag}</span>
                                </div>
                            </td>
                            <td>
                                <span style="color: var(--text-secondary); font-weight: 600;">${operator.qualification}</span>
                            </td>
                            <td>
                                <span style="padding: 0.25rem 0.75rem; background: ${roleStyle.bg}; color: ${roleStyle.color}; border-radius: 1rem; font-size: 0.75rem; font-weight: 700; border: 1px solid ${roleStyle.border};">
                                    ${operator.roleName || 'N/A'}
                                </span>
                            </td>
                            <td>
                                <span style="padding: 0.25rem 0.75rem; background: ${statusBg}; color: ${statusColor}; border-radius: 1rem; font-size: 0.75rem; font-weight: 700;">
                                    ${operator.status}
                                </span>
                            </td>
                            <td>
                                <span style="color: var(--text-muted); font-size: 0.875rem;">${operator.addedDate}</span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-secondary" onclick="editOperator(${operator.id})" title="Modifica operatore">
                                        <i class="fas fa-edit"></i>
                        </button>
                                    <button class="btn btn-sm" onclick="removeOperator(${operator.id})" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none;" title="Rimuovi operatore">
                                        <i class="fas fa-trash"></i>
                        </button>
                    </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            };

            // Funzione per creare una sezione gerarchica completa
            const createHierarchicalSection = (nucleo, operatorsList, icon, description, title) => {
                if (operatorsList.length === 0) return '';
                
                const availableCount = operatorsList.filter(op => op.status === 'Disponibile').length;
                
                return `
                    <div class="hierarchical-section ${nucleo}">
                        <div class="hierarchical-header">
                            <div class="hierarchical-title">
                                <div class="hierarchical-icon ${nucleo}">
                                    <i class="fas fa-${icon}"></i>
                                </div>
                                <span style="color: ${nucleo === 'dirigenziale' ? '#ef4444' : nucleo === 'amministrativo' ? '#10b981' : '#3b82f6'};">${title}</span>
                            </div>
                            <div class="hierarchical-stats">
                                <div class="hierarchical-stat ${nucleo}">
                                    <i class="fas fa-users"></i>
                                    <span>${operatorsList.length} Operatori</span>
                                </div>
                                <div class="hierarchical-stat ${nucleo}">
                                    <i class="fas fa-check-circle"></i>
                                    <span>${availableCount} Disponibili</span>
                                </div>
                            </div>
                        </div>
                        <div class="hierarchical-content">
                            <div class="hierarchical-description">
                                ${description}
                            </div>
                            <div class="hierarchical-table">
                    <table>
                        <thead>
                            <tr>
                                            <th>Nome e Discord</th>
                                            <th>Qualifica</th>
                                            <th>Ruolo</th>
                                <th>Stato</th>
                                            <th>Data Aggiunta</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                                        ${createOperatorRows(operatorsList)}
                        </tbody>
                    </table>
                            </div>
                        </div>
                </div>
                `;
            };

            const emptyState = operators.length === 0 ? `
                <div class="hierarchical-section" style="text-align: center; padding: 4rem 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1.5rem; opacity: 0.6;">👥</div>
                    <h2 style="color: #e2e8f0; margin-bottom: 1rem; font-size: 2rem;">Nessun Operatore Presente</h2>
                    <p style="color: #94a3b8; margin-bottom: 2rem; font-size: 1.125rem;">Inizia aggiungendo il primo operatore al sistema</p>
                    <button class="btn btn-primary" onclick="openAddOperator()" style="padding: 1rem 2rem; font-size: 1.125rem;">
                        <i class="fas fa-user-plus"></i> Aggiungi Primo Operatore
                    </button>
                </div>
            ` : '';

            return `
                <div class="page-header" style="opacity: 0; animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;">
                    <h1>🏅 Gestione Gerarchia di Reparto</h1>
                    <p>Amministrazione completa degli operatori U.O.P.I. organizzati per gerarchia</p>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="openAddOperator()">
                            <i class="fas fa-user-plus"></i> Aggiungi Operatore
                        </button>
                        <button class="btn btn-secondary" onclick="createBackup()">
                            <i class="fas fa-download"></i> Backup Dati
                        </button>
                        <button class="btn btn-secondary" onclick="restoreFromBackup()">
                            <i class="fas fa-upload"></i> Ripristina Backup
                        </button>
                        ${operators.length > 0 ? `
                            <button class="btn" onclick="clearAllOperators()" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none;">
                                <i class="fas fa-trash-alt"></i> Rimuovi Tutti
                            </button>
                        ` : ''}
                    </div>
                </div>

                ${operators.length === 0 ? emptyState : `
                    ${createHierarchicalSection('dirigenziale', dirigenzialeOps, 'crown', 'Responsabili delle decisioni strategiche e della direzione operativa dell\'unità. Comandano e coordinano tutte le attività.', '🏅 Nucleo Dirigenziale')}
                    ${createHierarchicalSection('amministrativo', amministrativoOps, 'clipboard-list', 'Gestione documentale, amministrazione e supporto logistico alle operazioni. Coordinano le risorse e la documentazione.', '📋 Nucleo Amministrativo')}
                    ${createHierarchicalSection('operativo', operativoOps, 'shield-alt', 'Personale operativo specializzato nell\'esecuzione diretta delle missioni. Eseguono le operazioni sul campo.', '👮 Nucleo Operativo')}
                `}
            `;
        }

        function getShiftsPage() {
            if (shifts.length === 0) {
            return `
                    <div class="page-header" style="opacity: 0; animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;">
                    <h1>🕐 Gestione Turni</h1>
                    <p>Programmazione e monitoraggio turni operativi</p>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="openAddShift()">
                                <i class="fas fa-plus"></i> Aggiungi Nuovo Turno
                        </button>
                    </div>
                </div>

                    <div class="card" style="text-align: center; padding: 3rem; margin-top: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">🕐</div>
                        <h3 style="color: #e2e8f0; margin-bottom: 1rem;">Nessun Turno Programmato</h3>
                        <p style="color: #94a3b8; margin-bottom: 2rem;">Inizia aggiungendo il primo turno utilizzando il modulo di attivazione</p>
                        <button class="btn btn-primary" onclick="openAddShift()" style="padding: 1rem 2rem; font-size: 1.125rem;">
                            <i class="fas fa-plus"></i> Aggiungi Primo Turno
                        </button>
                </div>
            `;
        }

            // Raggruppa i turni per giorno
            const shiftsByDay = {};
            shifts.forEach(shift => {
                const date = shift.createdDate;
                if (!shiftsByDay[date]) {
                    shiftsByDay[date] = [];
                }
                shiftsByDay[date].push(shift);
            });

            // Ordina le date
            const sortedDates = Object.keys(shiftsByDay).sort((a, b) => new Date(b) - new Date(a));

            const shiftsHTML = sortedDates.map(date => {
                const dayShifts = shiftsByDay[date];
                // Converte la data italiana (dd/mm/yyyy) in formato ISO per il parsing
                const dateParts = date.split('/');
                const isoDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                const dateObj = new Date(isoDate);
                
                const dayNameRaw = dateObj.toLocaleDateString('it-IT', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Capitalizza la prima lettera del giorno e del mese
                const dayName = dayNameRaw.replace(/\b\w/g, l => l.toUpperCase());

                // Separa attivazioni e disattivazioni
                const activations = dayShifts.filter(shift => shift.moduleType === 'patrol-activation');
                const deactivations = dayShifts.filter(shift => shift.moduleType === 'patrol-deactivation');
            
            return `
                    <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9)); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="padding: 1.5rem 1.5rem 1rem 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <h2 style="color: #e2e8f0; margin: 0; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-calendar-day" style="color: #3b82f6;"></i>
                                ${dayName}
                            </h2>
                            <p style="color: #94a3b8; margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                                ${dayShifts.length} turno${dayShifts.length !== 1 ? 'i' : ''} attivat${dayShifts.length !== 1 ? 'i' : 'o'}
                            </p>
                    </div>
                        <div style="padding: 1.5rem;">
                            ${activations.length > 0 ? `
                                <div style="margin-bottom: 2rem;">
                                    <h3 style="color: #10b981; font-size: 1rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-play-circle"></i> Attivazioni Pattuglie
                                    </h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                                        ${activations.map(shift => getSimpleShiftCard(shift)).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${deactivations.length > 0 ? `
                        <div>
                                    <h3 style="color: #ef4444; font-size: 1rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-stop-circle"></i> Disattivazioni Pattuglie
                                    </h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                                        ${deactivations.map(shift => getSimpleShiftCard(shift)).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="page-header" style="opacity: 0; animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;">
                    <h1>🕐 Gestione Turni</h1>
                    <p>Programmazione e monitoraggio turni operativi</p>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="openAddShift()">
                            <i class="fas fa-plus"></i> Aggiungi Nuovo Turno
                        </button>
                    </div>
                </div>

                ${shiftsHTML}
            `;
        }

        function getSimpleShiftCard(shift) {
            const isDeactivation = shift.moduleType === 'patrol-deactivation';
            const statusColor = shift.status === 'Attivo' ? '#10b981' : '#ef4444';
            const statusText = shift.status === 'Attivo' ? 'ATTIVO' : 'COMPLETATO';
            const iconColor = isDeactivation ? '#ef4444' : '#10b981';

            return `
                <div style="
                    background: linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8));
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 0.75rem;
                    padding: 1.25rem;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    position: relative;
                    overflow: hidden;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.borderColor='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'">
                    
                    <!-- Header -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="
                                width: 2.5rem; 
                                height: 2.5rem; 
                                background: linear-gradient(135deg, ${iconColor}, ${iconColor}dd);
                                border-radius: 0.5rem;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 1rem;
                            ">
                                ${isDeactivation ? '🚓' : '🚓'}
                        </div>
                        <div>
                                <h4 style="color: #e2e8f0; margin: 0; font-size: 1rem; font-weight: 600;">
                                    ${isDeactivation ? 'Disattivazione Pattuglia' : 'Attivazione Pattuglia'}
                                </h4>
                                <p style="color: #94a3b8; margin: 0; font-size: 0.75rem;">
                                    ${isDeactivation ? 'Turno Completato' : shift.patrolTypeName || 'Pattugliamento Cittadino/Intervento Rapine'}
                                </p>
                        </div>
                    </div>
                        <div style="
                            background: ${statusColor};
                            color: white;
                            padding: 0.25rem 0.75rem;
                            border-radius: 1rem;
                            font-size: 0.75rem;
                            font-weight: 600;
                        ">
                            ${statusText}
                        </div>
                    </div>

                    <!-- Info Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-play" style="color: #10b981; font-size: 0.875rem;"></i>
                            <div>
                                <div style="color: #94a3b8; font-size: 0.75rem; font-weight: 500;">ORARIO DI ATTIVAZIONE</div>
                                <div style="color: #e2e8f0; font-size: 0.875rem; font-weight: 600;">${isDeactivation ? shift.activationTime : shift.patrolTime}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas ${isDeactivation ? 'fa-stop' : 'fa-calendar'}" style="color: ${isDeactivation ? '#ef4444' : '#8b5cf6'}; font-size: 0.875rem;"></i>
                            <div>
                                <div style="color: #94a3b8; font-size: 0.75rem; font-weight: 500;">${isDeactivation ? 'ORARIO DI DISATTIVAZIONE' : 'DATA DI ATTIVAZIONE'}</div>
                                <div style="color: #e2e8f0; font-size: 0.875rem; font-weight: 600;">${isDeactivation ? shift.deactivationTime : shift.createdDate}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas ${isDeactivation ? 'fa-stopwatch' : 'fa-user'}" style="color: ${isDeactivation ? '#f59e0b' : '#10b981'}; font-size: 0.875rem;"></i>
                            <div>
                                <div style="color: #94a3b8; font-size: 0.75rem; font-weight: 500;">${isDeactivation ? 'DURATA' : 'GESTITO DA'}</div>
                                <div style="color: #e2e8f0; font-size: 0.875rem; font-weight: 600;">${isDeactivation ? (shift.duration && shift.duration !== 'NaNh NaNm' ? shift.duration : 'N/A') : (shift.managerName + (shift.managerQualification ? ` - ${shift.managerQualification}` : ''))}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas ${isDeactivation ? 'fa-calendar' : 'fa-car'}" style="color: ${isDeactivation ? '#8b5cf6' : '#f59e0b'}; font-size: 0.875rem;"></i>
                            <div>
                                <div style="color: #94a3b8; font-size: 0.75rem; font-weight: 500;">${isDeactivation ? 'DATA' : 'VEICOLO'}</div>
                                <div style="color: #e2e8f0; font-size: 0.875rem; font-weight: 600;">${isDeactivation ? shift.createdDate : shift.patrolVehicleName}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Operatori -->
                    <div style="margin-bottom: 1rem;">
                        <div style="color: #94a3b8; font-size: 0.75rem; font-weight: 500; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-users" style="color: ${iconColor};"></i>
                            ${isDeactivation ? 'OPERATORI IN RIENTRO' : 'OPERATORI IN USCITA'}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <div style="
                                background: linear-gradient(135deg, #1e40af, #1e3a8a);
                                color: white;
                                padding: 0.375rem 0.75rem;
                                border-radius: 0.5rem;
                                font-size: 0.75rem;
                                font-weight: 500;
                                flex: 1;
                                text-align: center;
                            ">${shift.operator1Name}${shift.operator1Qualification ? ` - ${shift.operator1Qualification}` : ''}</div>
                            <div style="
                                background: linear-gradient(135deg, #059669, #047857);
                                color: white;
                                padding: 0.375rem 0.75rem;
                                border-radius: 0.5rem;
                                font-size: 0.75rem;
                                font-weight: 500;
                                flex: 1;
                                text-align: center;
                            ">${shift.operator2Name}${shift.operator2Qualification ? ` - ${shift.operator2Qualification}` : ''}</div>
                        </div>
                    </div>

                    <!-- Azione -->
                    <button onclick="editShift(${shift.id})" style="
                        width: 100%;
                        background: linear-gradient(135deg, #3b82f6, #2563eb);
                        color: white;
                        border: none;
                        border-radius: 0.5rem;
                        padding: 0.75rem;
                        font-size: 0.875rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 0.5rem;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <i class="fas fa-edit"></i> Modifica
                        </button>
                </div>
            `;
        }

        function getShiftCard(shift) {
            const isDeactivation = shift.moduleType === 'patrol-deactivation';
            const statusColor = shift.status === 'Attivo' ? '#10b981' : (isDeactivation ? '#ef4444' : '#3b82f6');
            const statusBg = shift.status === 'Attivo' ? 'rgba(16, 185, 129, 0.15)' : (isDeactivation ? 'rgba(239, 68, 68, 0.15)' : 'rgba(59, 130, 246, 0.15)');
            const iconColor = isDeactivation ? '#ef4444' : '#10b981';
            const headerBg = isDeactivation ? 'rgba(239, 68, 68, 0.1)' : 'rgba(16, 185, 129, 0.1)';
            
            return `
                <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9)); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); max-width: 400px;">
                    <!-- Header compatto -->
                    <div style="position: relative; padding: 1rem; background: linear-gradient(135deg, ${headerBg}, rgba(59, 130, 246, 0.05)); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 2rem; height: 2rem; border-radius: 0.5rem; background: linear-gradient(135deg, ${iconColor}, ${isDeactivation ? '#dc2626' : '#059669'}); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas ${isDeactivation ? 'fa-car-crash' : 'fa-car'}" style="color: white; font-size: 0.875rem;"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 1rem; font-weight: 700; color: #e2e8f0; margin: 0;">${isDeactivation ? 'Disattivazione Pattuglia' : 'Attivazione Pattuglia'}</h3>
                                    <p style="font-size: 0.75rem; color: #94a3b8; margin: 0;">${isDeactivation ? 'Turno Completato' : (shift.patrolTypeName || 'Pattugliamento')}</p>
                                </div>
                            </div>
                            <div style="padding: 0.25rem 0.75rem; background: ${statusBg}; border: 1px solid ${statusColor}; border-radius: 1rem; color: ${statusColor}; font-size: 0.625rem; font-weight: 700; text-transform: uppercase;">
                                ${shift.status}
                            </div>
                        </div>
                    </div>

                    <!-- Contenuto compatto -->
                    <div style="padding: 1rem;">
                        <!-- Informazioni principali in una riga -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 0.5rem; padding: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.08);">
                                <div style="display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.25rem;">
                                    <i class="fas fa-clock" style="color: #3b82f6; font-size: 0.75rem;"></i>
                                    <span style="font-size: 0.625rem; color: #64748b; font-weight: 600; text-transform: uppercase;">${isDeactivation ? 'Disattivazione' : 'Attivazione'}</span>
                                </div>
                                <div style="font-size: 0.875rem; font-weight: 700; color: #e2e8f0;">${isDeactivation ? shift.deactivationTime : shift.patrolTime}</div>
                            </div>
                            
                            ${!isDeactivation ? `
                            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 0.5rem; padding: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.08);">
                                <div style="display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.25rem;">
                                    <i class="fas fa-user-tie" style="color: #10b981; font-size: 0.75rem;"></i>
                                    <span style="font-size: 0.625rem; color: #64748b; font-weight: 600; text-transform: uppercase;">Gestito da</span>
                                </div>
                                <div style="font-size: 0.875rem; font-weight: 700; color: #e2e8f0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${shift.managerName}</div>
                            </div>
                            ` : `
                            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 0.5rem; padding: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.08);">
                                <div style="display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.25rem;">
                                    <i class="fas fa-stopwatch" style="color: #ef4444; font-size: 0.75rem;"></i>
                                    <span style="font-size: 0.625rem; color: #64748b; font-weight: 600; text-transform: uppercase;">Durata</span>
                                </div>
                                <div style="font-size: 0.875rem; font-weight: 700; color: #e2e8f0;">${shift.duration || 'N/A'}</div>
                            </div>
                            `}
                        </div>

                        <!-- Informazioni secondarie -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                            ${!isDeactivation ? `
                            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 0.5rem; padding: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.08);">
                                <div style="display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.25rem;">
                                    <i class="fas fa-car-side" style="color: #f59e0b; font-size: 0.75rem;"></i>
                                    <span style="font-size: 0.625rem; color: #64748b; font-weight: 600; text-transform: uppercase;">Veicolo</span>
                                </div>
                                <div style="font-size: 0.75rem; font-weight: 600; color: #e2e8f0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${shift.patrolVehicleName}</div>
                            </div>
                            ` : `
                            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 0.5rem; padding: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.08);">
                                <div style="display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.25rem;">
                                    <i class="fas fa-play" style="color: #10b981; font-size: 0.75rem;"></i>
                                    <span style="font-size: 0.625rem; color: #64748b; font-weight: 600; text-transform: uppercase;">Inizio</span>
                                </div>
                                <div style="font-size: 0.75rem; font-weight: 600; color: #e2e8f0;">${shift.activationTime || 'N/A'}</div>
                            </div>
                            `}
                            
                            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 0.5rem; padding: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.08);">
                                <div style="display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.25rem;">
                                    <i class="fas fa-calendar-plus" style="color: #8b5cf6; font-size: 0.75rem;"></i>
                                    <span style="font-size: 0.625rem; color: #64748b; font-weight: 600; text-transform: uppercase;">Data</span>
                                </div>
                                <div style="font-size: 0.75rem; font-weight: 600; color: #e2e8f0;">${shift.createdDate}</div>
                            </div>
                        </div>

                        <!-- Operatori compatti -->
                        <div style="background: rgba(255, 255, 255, 0.03); border-radius: 0.5rem; padding: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.08); margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-users" style="color: #ef4444; font-size: 0.75rem;"></i>
                                <span style="font-size: 0.625rem; color: #64748b; font-weight: 600; text-transform: uppercase;">${isDeactivation ? 'Operatori in Rientro' : 'Operatori in Uscita'}</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <div style="flex: 1; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 0.375rem; padding: 0.5rem; text-align: center;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #3b82f6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${shift.operator1Name}</div>
                                </div>
                                <div style="flex: 1; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 0.375rem; padding: 0.5rem; text-align: center;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #10b981; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${shift.operator2Name}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Azione compatta -->
                        <div style="display: flex; justify-content: center; padding-top: 0.75rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                            <button class="btn btn-sm" onclick="editShift(${shift.id})" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; transition: all 0.3s ease; padding: 0.5rem 1.5rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.875rem;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <i class="fas fa-edit"></i> Modifica
                        </button>
                    </div>
                    </div>

                    <!-- Effetto di bordo animato -->
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, #10b981, transparent); animation: shimmer 3s ease-in-out infinite;"></div>
                </div>
            `;
        }

        function getCreditsPage() {
            return `
                <div class="page-header" style="opacity: 0; animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;">
                    <h1>🔰 Crediti</h1>
                    <p>Informazioni sullo sviluppatore e riconoscimenti</p>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem;">
                    <!-- Card Sviluppatore -->
                    <div class="card" style="text-align: center; padding: 3rem 2rem;">
                        <div style="position: relative; display: inline-block; margin-bottom: 2rem;">
                            <img src="https://i.imgur.com/8zbuZPh.png" 
                                 alt="Ryze Profile" 
                                 style="width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--gradient-primary); box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); object-fit: cover;">
                            <div style="position: absolute; bottom: 5px; right: 5px; width: 30px; height: 30px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid rgba(30, 41, 59, 0.95);">
                                <i class="fas fa-check" style="color: white; font-size: 0.75rem;"></i>
                            </div>
                        </div>
                        
                        <h2 style="color: #e2e8f0; margin-bottom: 0.5rem; font-size: 1.75rem; font-weight: 800;">Ryze</h2>
                        <p style="color: #94a3b8; margin-bottom: 1.5rem; font-size: 1rem;">Sviluppatore & Designer</p>
                        
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #3b82f6; margin-bottom: 1rem; font-size: 1.125rem; font-weight: 700;">🎯 Specializzazioni</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                                <span style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 0.5rem 1rem; border-radius: 0.75rem; font-size: 0.875rem; font-weight: 600;">Frontend Development</span>
                                <span style="background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 0.5rem 1rem; border-radius: 0.75rem; font-size: 0.875rem; font-weight: 600;">UI/UX Design</span>
                                <span style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6; padding: 0.5rem 1rem; border-radius: 0.75rem; font-size: 0.875rem; font-weight: 600;">JavaScript</span>
                                <span style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; padding: 0.5rem 1rem; border-radius: 0.75rem; font-size: 0.875rem; font-weight: 600;">CSS Animations</span>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn btn-primary" onclick="UI.notify('Contatto Discord: Ryze#0000', 'info', '📧 Contatto')">
                                <i class="fab fa-discord"></i> Discord
                            </button>
                            <button class="btn btn-secondary" onclick="UI.notify('GitHub: github.com/ryze', 'info', '🐙 GitHub')">
                                <i class="fab fa-github"></i> GitHub
                            </button>
                        </div>
                    </div>

                    <!-- Card Progetto -->
                    <div class="card" style="padding: 2rem;">
                        <h3 style="color: #e2e8f0; margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 700;">🚀 U.O.P.I. Dashboard</h3>
                        
                        <div style="margin-bottom: 2rem;">
                            <h4 style="color: #3b82f6; margin-bottom: 1rem; font-size: 1.125rem; font-weight: 600;">📋 Caratteristiche</h4>
                            <ul style="color: #e2e8f0; list-style: none; padding: 0;">
                                <li style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.75rem;">
                                    <i class="fas fa-check-circle" style="color: #10b981; font-size: 1rem;"></i>
                                    <span>Sistema di gestione operatori completo</span>
                                </li>
                                <li style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.75rem;">
                                    <i class="fas fa-check-circle" style="color: #10b981; font-size: 1rem;"></i>
                                    <span>Gestione turni con moduli specializzati</span>
                                </li>
                                <li style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.75rem;">
                                    <i class="fas fa-check-circle" style="color: #10b981; font-size: 1rem;"></i>
                                    <span>Dashboard con statistiche real-time</span>
                                </li>
                                <li style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.75rem;">
                                    <i class="fas fa-check-circle" style="color: #10b981; font-size: 1rem;"></i>
                                    <span>Sistema notifiche avanzato</span>
                                </li>
                                <li style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.75rem;">
                                    <i class="fas fa-check-circle" style="color: #10b981; font-size: 1rem;"></i>
                                    <span>Design responsive e moderno</span>
                                </li>
                            </ul>
                        </div>

                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 1rem; padding: 1.5rem;">
                            <h4 style="color: #10b981; margin-bottom: 1rem; font-size: 1.125rem; font-weight: 600;">⚡ Tecnologie Utilizzate</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                <div style="color: #e2e8f0; font-size: 0.875rem;">
                                    <strong>Frontend:</strong><br>
                                    HTML5, CSS3, JavaScript ES6+
                                </div>
                                <div style="color: #e2e8f0; font-size: 0.875rem;">
                                    <strong>Design:</strong><br>
                                    CSS Grid, Flexbox, Animations
                                </div>
                                <div style="color: #e2e8f0; font-size: 0.875rem;">
                                    <strong>Icons:</strong><br>
                                    Font Awesome 6.4.0
                                </div>
                                <div style="color: #e2e8f0; font-size: 0.875rem;">
                                    <strong>Fonts:</strong><br>
                                    Inter (Google Fonts)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Riconoscimenti -->
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 style="color: #e2e8f0; margin-bottom: 2rem; font-size: 1.5rem; font-weight: 700; text-align: center;">🏆 Riconoscimenti</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 1rem; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 1rem;">🎨</div>
                            <h4 style="color: #3b82f6; margin-bottom: 0.5rem; font-weight: 700;">Design System</h4>
                            <p style="color: #e2e8f0; font-size: 0.875rem;">Sistema di design coerente e professionale con palette colori e animazioni fluide</p>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 1rem; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 1rem;">⚡</div>
                            <h4 style="color: #10b981; margin-bottom: 0.5rem; font-weight: 700;">Performance</h4>
                            <p style="color: #e2e8f0; font-size: 0.875rem;">Ottimizzazioni per caricamento veloce e esperienza utente fluida</p>
                        </div>
                        
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8b5cf6; border-radius: 1rem; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 1rem;">🔧</div>
                            <h4 style="color: #8b5cf6; margin-bottom: 0.5rem; font-weight: 700;">Funzionalità</h4>
                            <p style="color: #e2e8f0; font-size: 0.875rem;">Sistema completo di gestione con CRUD operations e validazioni</p>
                        </div>
                        
                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; border-radius: 1rem; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 1rem;">📱</div>
                            <h4 style="color: #f59e0b; margin-bottom: 0.5rem; font-weight: 700;">Responsive</h4>
                            <p style="color: #e2e8f0; font-size: 0.875rem;">Design adattivo per tutti i dispositivi e risoluzioni</p>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="card" style="text-align: center; padding: 2rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🙏</div>
                    <h3 style="color: #e2e8f0; margin-bottom: 1rem; font-size: 1.5rem; font-weight: 700;">Grazie per aver utilizzato U.O.P.I.</h3>
                    <p style="color: #94a3b8; margin-bottom: 2rem; font-size: 1.125rem;">Sviluppato con ❤️ da <strong style="color: #3b82f6;">Ryze</strong></p>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="UI.notify('Versione 1.0.0 - Build 2024', 'info', 'ℹ️ Informazioni')">
                            <i class="fas fa-info-circle"></i> Versione
                        </button>
                        <button class="btn btn-secondary" onclick="loadPage('overview')">
                            <i class="fas fa-home"></i> Torna alla Dashboard
                        </button>
                    </div>
                </div>
            `;
        }

        // ========== MODAL OPERATORI ==========
        function openAddOperator() {
            const form = `
                <div style="display: flex; flex-direction: column; gap: 1.25rem;">
                    <!-- Sezione Informazioni Personali -->
                    <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 0.75rem; padding: 1rem;">
                        <h3 style="color: #3b82f6; margin-bottom: 1rem; font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user"></i> Informazioni Personali
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <div>
                                <label style="display: block; margin-bottom: 0.375rem; font-weight: 600; color: var(--text-primary); font-size: 0.8125rem;">Nome</label>
                                <input type="text" id="opFirstName" placeholder="Nome" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.9375rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 2px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                        </div>
                        <div>
                                <label style="display: block; margin-bottom: 0.375rem; font-weight: 600; color: var(--text-primary); font-size: 0.8125rem;">Cognome</label>
                                <input type="text" id="opLastName" placeholder="Cognome" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.9375rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 2px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                        </div>
                    </div>
                    </div>

                    <!-- Sezione Qualifica -->
                    <div style="background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 0.75rem; padding: 1rem;">
                        <h3 style="color: #10b981; margin-bottom: 1rem; font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-graduation-cap"></i> Qualifica Professionale
                        </h3>
                        <div>
                            <label style="display: block; margin-bottom: 0.375rem; font-weight: 600; color: var(--text-primary); font-size: 0.8125rem;">Qualifica</label>
                            <input type="text" id="opQualification" placeholder="Es. Agente, Commissario, Dirigente..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.9375rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 2px rgba(16, 185, 129, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                        </div>
                    </div>

                    <!-- Sezione Discord -->
                    <div style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 0.75rem; padding: 1rem;">
                        <h3 style="color: #8b5cf6; margin-bottom: 1rem; font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fab fa-discord"></i> Informazioni Discord
                        </h3>
                        <div>
                            <label style="display: block; margin-bottom: 0.375rem; font-weight: 600; color: var(--text-primary); font-size: 0.8125rem;">Tag Discord</label>
                            <input type="text" id="opDiscordTag" placeholder="username#0000" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.9375rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#8b5cf6'; this.style.boxShadow='0 0 0 2px rgba(139, 92, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                            <p style="color: var(--text-muted); font-size: 0.6875rem; margin-top: 0.375rem;">Formato: username#0000</p>
                        </div>
                    </div>

                    <!-- Sezione Ruolo Aggiuntivo -->
                    <div style="background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 0.75rem; padding: 1rem;">
                        <h3 style="color: #f59e0b; margin-bottom: 1rem; font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user-tag"></i> Ruolo Aggiuntivo
                        </h3>
                        <div>
                            <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: var(--text-primary); font-size: 0.8125rem;">Seleziona ruolo aggiuntivo</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(239, 68, 68, 0.15)'; this.style.borderColor='rgba(239, 68, 68, 0.5)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.borderColor='rgba(239, 68, 68, 0.3)'">
                                    <input type="radio" name="opRole" value="dirigenziale" style="margin: 0;">
                                    <span style="color: #ef4444; font-weight: 600; font-size: 0.875rem;">🏅・Nucleo Dirigenziale</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 0.5rem; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(16, 185, 129, 0.15)'; this.style.borderColor='rgba(16, 185, 129, 0.5)'" onmouseout="this.style.background='rgba(16, 185, 129, 0.1)'; this.style.borderColor='rgba(16, 185, 129, 0.3)'">
                                    <input type="radio" name="opRole" value="amministrativo" style="margin: 0;">
                                    <span style="color: #10b981; font-weight: 600; font-size: 0.875rem;">📋・Nucleo Amministrativo</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 0.5rem; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'; this.style.borderColor='rgba(59, 130, 246, 0.5)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'; this.style.borderColor='rgba(59, 130, 246, 0.3)'">
                                    <input type="radio" name="opRole" value="operativo" style="margin: 0;">
                                    <span style="color: #3b82f6; font-weight: 600; font-size: 0.875rem;">👮・Nucleo Operativo</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Annulla</button>
                <button class="btn btn-primary" onclick="saveOperator()" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                    <i class="fas fa-user-plus"></i> Aggiungi Operatore
                </button>
            `;
            
            UI.modal('👤 Aggiungi Nuovo Operatore', form, footer);
        }

        function saveOperator() {
            const firstName = document.getElementById('opFirstName')?.value;
            const lastName = document.getElementById('opLastName')?.value;
            const qualification = document.getElementById('opQualification')?.value;
            const discordTag = document.getElementById('opDiscordTag')?.value;
            const role = document.querySelector('input[name="opRole"]:checked')?.value;
            
            // Validazione campi obbligatori
            if (!firstName || !lastName || !qualification || !discordTag || !role) {
                UI.notify('⚠️ Compila tutti i campi obbligatori!', 'error', '❌ Errore Validazione');
                return;
            }
            
            const fullName = `${firstName} ${lastName}`;
            
            // Verifica se l'operatore esiste già
            const existingOperator = operators.find(op => 
                op.name.toLowerCase() === fullName.toLowerCase() || 
                op.discordTag === discordTag
            );
            if (existingOperator) {
                UI.notify('⚠️ Operatore già esistente con questo nome o tag Discord!', 'error', '❌ Duplicato');
                return;
            }
            
            // Mappa dei ruoli per i nomi completi
            const roleNames = {
                'dirigenziale': '🏅・Nucleo Dirigenziale',
                'amministrativo': '📋・Nucleo Amministrativo',
                'operativo': '👮・Nucleo Operativo'
            };
            
            // Aggiungi nuovo operatore
            const newOperator = {
                id: Date.now(),
                name: fullName,
                firstName: firstName,
                lastName: lastName,
                qualification: qualification,
                discordTag: discordTag,
                role: role,
                roleName: roleNames[role],
                status: 'Disponibile',
                addedDate: new Date().toLocaleDateString('it-IT')
            };
            
            operators.push(newOperator);
            
            // Salva automaticamente nel localStorage
            saveOperators();
            
            UI.loading('Salvataggio operatore...', true);
            setTimeout(() => {
                UI.loading('', false);
                UI.notify(`✅ Operatore ${fullName} aggiunto con successo!`, 'success', '👤 Operatore Aggiunto');
                UI.closeModal();
                // Ricarica pagina con animazione
                setTimeout(() => loadPage('personnel'), 500);
                // Aggiorna statistiche panoramica
                setTimeout(() => updateOverviewStats(), 600);
            }, 1500);
        }

        function removeOperator(operatorId) {
            const operator = operators.find(op => op.id === operatorId);
            if (!operator) {
                UI.notify('⚠️ Operatore non trovato!', 'error');
                return;
            }
            
            const confirmContent = `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem; color: #ef4444;">⚠️</div>
                    <h3 style="color: #fff; margin-bottom: 1rem;">Conferma Rimozione</h3>
                    <p style="color: #94a3b8; margin-bottom: 1.5rem;">Sei sicuro di voler rimuovere l'operatore <strong>${operator.name}</strong>?</p>
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="color: #ef4444; font-weight: 600; margin-bottom: 0.5rem;">Dettagli Operatore:</div>
                        <div style="color: #e2e8f0; font-size: 0.875rem;">
                            <div><strong>Nome:</strong> ${operator.name}</div>
                            <div><strong>Qualifica:</strong> ${operator.qualification}</div>
                            <div><strong>Discord:</strong> ${operator.discordTag}</div>
                            <div><strong>Ruolo:</strong> ${operator.roleName}</div>
                            <div><strong>Aggiunto il:</strong> ${operator.addedDate}</div>
                        </div>
                    </div>
                    <p style="color: #f59e0b; font-size: 0.875rem; font-weight: 600;">⚠️ Questa azione non può essere annullata!</p>
                </div>
            `;
            
            const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Annulla</button>
                <button class="btn" onclick="confirmRemoveOperator(${operatorId})" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none;">
                    <i class="fas fa-trash"></i> Rimuovi Definitivamente
                </button>
            `;
            
            UI.modal('🗑️ Rimuovi Operatore', confirmContent, footer);
        }

        function confirmRemoveOperator(operatorId) {
            const operator = operators.find(op => op.id === operatorId);
            if (!operator) {
                UI.notify('⚠️ Operatore non trovato!', 'error', '❌ Errore');
                return;
            }
            
            UI.loading('Rimozione operatore...', true);
            
            setTimeout(() => {
                // Rimuovi operatore dall'array
                operators = operators.filter(op => op.id !== operatorId);
                
                // Salva automaticamente nel localStorage
                saveOperators();
                
                UI.loading('', false);
                UI.notify(`✅ Operatore ${operator.name} rimosso!`, 'success', '🗑️ Rimozione Completata');
                UI.closeModal();
                
                // Ricarica pagina con animazione
                setTimeout(() => loadPage('personnel'), 500);
                // Aggiorna statistiche panoramica
                setTimeout(() => updateOverviewStats(), 600);
            }, 1500);
        }

        function editOperator(operatorId) {
            const operator = operators.find(op => op.id === operatorId);
            if (!operator) {
                UI.notify('⚠️ Operatore non trovato!', 'error', '❌ Errore');
                return;
            }

            const form = `
                <div style="display: flex; flex-direction: column; gap: 1.25rem;">
                    <!-- Sezione Informazioni Personali -->
                    <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 0.75rem; padding: 1rem;">
                        <h3 style="color: #3b82f6; margin-bottom: 1rem; font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user"></i> Informazioni Personali
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.375rem; font-weight: 600; color: var(--text-primary); font-size: 0.8125rem;">Nome</label>
                                <input type="text" id="editFirstName" value="${operator.firstName}" placeholder="Nome" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.9375rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 2px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.375rem; font-weight: 600; color: var(--text-primary); font-size: 0.8125rem;">Cognome</label>
                                <input type="text" id="editLastName" value="${operator.lastName}" placeholder="Cognome" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.9375rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 2px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                            </div>
                        </div>
                    </div>

                    <!-- Sezione Qualifica -->
                    <div style="background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 0.75rem; padding: 1rem;">
                        <h3 style="color: #10b981; margin-bottom: 1rem; font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-graduation-cap"></i> Qualifica Professionale
                        </h3>
                        <div>
                            <label style="display: block; margin-bottom: 0.375rem; font-weight: 600; color: var(--text-primary); font-size: 0.8125rem;">Qualifica</label>
                            <input type="text" id="editQualification" value="${operator.qualification}" placeholder="Es. Agente, Commissario, Dirigente..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.9375rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 2px rgba(16, 185, 129, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                        </div>
                    </div>

                    <!-- Sezione Discord -->
                    <div style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 0.75rem; padding: 1rem;">
                        <h3 style="color: #8b5cf6; margin-bottom: 1rem; font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fab fa-discord"></i> Informazioni Discord
                        </h3>
                        <div>
                            <label style="display: block; margin-bottom: 0.375rem; font-weight: 600; color: var(--text-primary); font-size: 0.8125rem;">Tag Discord</label>
                            <input type="text" id="editDiscordTag" value="${operator.discordTag}" placeholder="username#0000" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.9375rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#8b5cf6'; this.style.boxShadow='0 0 0 2px rgba(139, 92, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                            <p style="color: var(--text-muted); font-size: 0.6875rem; margin-top: 0.375rem;">Formato: username#0000</p>
                        </div>
                    </div>

                    <!-- Sezione Ruolo Aggiuntivo -->
                    <div style="background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 0.75rem; padding: 1rem;">
                        <h3 style="color: #f59e0b; margin-bottom: 1rem; font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user-tag"></i> Ruolo Aggiuntivo
                        </h3>
                        <div>
                            <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: var(--text-primary); font-size: 0.8125rem;">Seleziona ruolo aggiuntivo</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(239, 68, 68, 0.15)'; this.style.borderColor='rgba(239, 68, 68, 0.5)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.borderColor='rgba(239, 68, 68, 0.3)'">
                                    <input type="radio" name="editRole" value="dirigenziale" ${operator.role === 'dirigenziale' ? 'checked' : ''} style="margin: 0;">
                                    <span style="color: #ef4444; font-weight: 600; font-size: 0.875rem;">🏅・Nucleo Dirigenziale</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 0.5rem; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(16, 185, 129, 0.15)'; this.style.borderColor='rgba(16, 185, 129, 0.5)'" onmouseout="this.style.background='rgba(16, 185, 129, 0.1)'; this.style.borderColor='rgba(16, 185, 129, 0.3)'">
                                    <input type="radio" name="editRole" value="amministrativo" ${operator.role === 'amministrativo' ? 'checked' : ''} style="margin: 0;">
                                    <span style="color: #10b981; font-weight: 600; font-size: 0.875rem;">📋・Nucleo Amministrativo</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 0.5rem; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'; this.style.borderColor='rgba(59, 130, 246, 0.5)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'; this.style.borderColor='rgba(59, 130, 246, 0.3)'">
                                    <input type="radio" name="editRole" value="operativo" ${operator.role === 'operativo' ? 'checked' : ''} style="margin: 0;">
                                    <span style="color: #3b82f6; font-weight: 600; font-size: 0.875rem;">👮・Nucleo Operativo</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Annulla</button>
                <button class="btn btn-primary" onclick="updateOperator(${operatorId})" style="background: linear-gradient(135deg, #10b981, #059669);">
                    <i class="fas fa-save"></i> Salva Modifiche
                </button>
            `;
            
            UI.modal('✏️ Modifica Operatore', form, footer);
        }

        function updateOperator(operatorId) {
            const firstName = document.getElementById('editFirstName')?.value;
            const lastName = document.getElementById('editLastName')?.value;
            const qualification = document.getElementById('editQualification')?.value;
            const discordTag = document.getElementById('editDiscordTag')?.value;
            const role = document.querySelector('input[name="editRole"]:checked')?.value;
            
            // Validazione campi obbligatori
            if (!firstName || !lastName || !qualification || !discordTag || !role) {
                UI.notify('⚠️ Compila tutti i campi obbligatori!', 'error', '❌ Errore Validazione');
                return;
            }
            
            const fullName = `${firstName} ${lastName}`;
            
            // Trova l'operatore da aggiornare
            const operatorIndex = operators.findIndex(op => op.id === operatorId);
            if (operatorIndex === -1) {
                UI.notify('⚠️ Operatore non trovato!', 'error', '❌ Errore');
                return;
            }
            
            // Verifica se esiste già un altro operatore con lo stesso nome o Discord tag
            const existingOperator = operators.find(op => 
                op.id !== operatorId && 
                (op.name.toLowerCase() === fullName.toLowerCase() || op.discordTag === discordTag)
            );
            if (existingOperator) {
                UI.notify('⚠️ Esiste già un operatore con questo nome o tag Discord!', 'error', '❌ Duplicato');
                return;
            }
            
            // Mappa dei ruoli per i nomi completi
            const roleNames = {
                'dirigenziale': '🏅・Nucleo Dirigenziale',
                'amministrativo': '📋・Nucleo Amministrativo',
                'operativo': '👮・Nucleo Operativo'
            };
            
            // Aggiorna l'operatore
            operators[operatorIndex] = {
                ...operators[operatorIndex],
                name: fullName,
                firstName: firstName,
                lastName: lastName,
                qualification: qualification,
                discordTag: discordTag,
                role: role,
                roleName: roleNames[role]
            };
            
            // Salva automaticamente nel localStorage
            saveOperators();
            
            UI.loading('Salvataggio modifiche...', true);
            setTimeout(() => {
                UI.loading('', false);
                UI.notify(`✅ Operatore ${fullName} aggiornato con successo!`, 'success', '✏️ Modifiche Salvate');
                UI.closeModal();
                // Ricarica pagina con animazione
                setTimeout(() => loadPage('personnel'), 500);
                // Aggiorna statistiche panoramica
                setTimeout(() => updateOverviewStats(), 600);
            }, 1500);
        }

        function clearAllOperators() {
            if (operators.length === 0) {
                UI.notify('⚠️ Nessun operatore da rimuovere!', 'info');
                return;
            }
            
            const confirmContent = `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem; color: #ef4444;">⚠️</div>
                    <h3 style="color: #fff; margin-bottom: 1rem;">Rimuovi Tutti gli Operatori</h3>
                    <p style="color: #94a3b8; margin-bottom: 1.5rem;">Sei sicuro di voler rimuovere <strong>tutti i ${operators.length} operatori</strong>?</p>
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="color: #ef4444; font-weight: 600; margin-bottom: 0.5rem;">Operatori che verranno rimossi:</div>
                        <div style="color: #e2e8f0; font-size: 0.875rem; max-height: 200px; overflow-y: auto;">
                            ${operators.map(op => `<div>• ${op.name} (${op.qualification}) - ${op.roleName}</div>`).join('')}
                        </div>
                    </div>
                    <p style="color: #f59e0b; font-size: 0.875rem; font-weight: 600;">⚠️ Questa azione non può essere annullata!</p>
                </div>
            `;
            
            const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Annulla</button>
                <button class="btn" onclick="confirmClearAllOperators()" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none;">
                    <i class="fas fa-trash-alt"></i> Rimuovi Tutti (${operators.length})
                </button>
            `;
            
            UI.modal('🗑️ Rimuovi Tutti gli Operatori', confirmContent, footer);
        }

        function confirmClearAllOperators() {
            const count = operators.length;
            
            UI.loading('Rimozione operatori...', true);
            
            setTimeout(() => {
                // Svuota array operatori
                operators = [];
                
                // Salva automaticamente nel localStorage
                saveOperators();
                
                UI.loading('', false);
                UI.notify(`✅ Rimossi ${count} operatori!`, 'success');
                UI.closeModal();
                
                // Ricarica pagina con animazione
                setTimeout(() => loadPage('personnel'), 500);
                // Aggiorna statistiche panoramica
                setTimeout(() => updateOverviewStats(), 600);
            }, 1500);
        }

        // ========== MODAL TURNI ==========
        function openAddShift() {
            const moduleSelection = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #fff;">Seleziona Tipo di Modulo</h3>
                    <p style="color: #94a3b8; margin-bottom: 2rem;">Scegli il tipo di operazione per il nuovo turno</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                    <button class="module-btn" onclick="selectModule('patrol-activation')" style="
                        padding: 1.5rem; 
                        background: linear-gradient(135deg, #10b981, #059669); 
                        border: none; 
                        border-radius: 1rem; 
                        color: white; 
                        font-weight: 700; 
                        font-size: 1rem; 
                        cursor: pointer; 
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                        position: relative;
                        overflow: hidden;
                    " onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">🚓</div>
                        <div>Modulo Attivazione</div>
                        <div style="font-size: 0.875rem; opacity: 0.9;">Pattuglie</div>
                    </button>
                    
                    <button class="module-btn" onclick="selectModule('patrol-deactivation')" style="
                        padding: 1.5rem; 
                        background: linear-gradient(135deg, #ef4444, #dc2626); 
                        border: none; 
                        border-radius: 1rem; 
                        color: white; 
                        font-weight: 700; 
                        font-size: 1rem; 
                        cursor: pointer; 
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                        position: relative;
                        overflow: hidden;
                    " onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 8px 20px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.3)'">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">🚓</div>
                        <div>Modulo Disattivazione</div>
                        <div style="font-size: 0.875rem; opacity: 0.9;">Pattuglie</div>
                    </button>
                    
                    <button class="module-btn" onclick="selectModule('heist-activation')" style="
                        padding: 1.5rem; 
                        background: linear-gradient(135deg, #10b981, #059669); 
                        border: none; 
                        border-radius: 1rem; 
                        color: white; 
                        font-weight: 700; 
                        font-size: 1rem; 
                        cursor: pointer; 
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                        position: relative;
                        overflow: hidden;
                    " onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">💰</div>
                        <div>Modulo Attivazione</div>
                        <div style="font-size: 0.875rem; opacity: 0.9;">Grandi Rapine</div>
                    </button>
                    
                    <button class="module-btn" onclick="selectModule('heist-deactivation')" style="
                        padding: 1.5rem; 
                        background: linear-gradient(135deg, #ef4444, #dc2626); 
                        border: none; 
                        border-radius: 1rem; 
                        color: white; 
                        font-weight: 700; 
                        font-size: 1rem; 
                        cursor: pointer; 
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                        position: relative;
                        overflow: hidden;
                    " onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 8px 20px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.3)'">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">💰</div>
                        <div>Modulo Disattivazione</div>
                        <div style="font-size: 0.875rem; opacity: 0.9;">Grandi Rapine</div>
                    </button>
                </div>
                
                <div style="text-align: center; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.12);">
                    <button class="btn btn-secondary" onclick="UI.closeModal()" style="margin-right: 1rem;">
                        <i class="fas fa-arrow-left"></i> Indietro
                    </button>
                </div>
            `;
            
            UI.modal('🕐 Seleziona Tipo di Modulo', moduleSelection, '');
        }

        function selectModule(moduleType) {
            const moduleNames = {
                'patrol-activation': '🚓・Modulo Attivazione Pattuglie',
                'patrol-deactivation': '🚓・Modulo Disattivazione Pattuglie',
                'heist-activation': '💰・Modulo Attivazione Grandi Rapine',
                'heist-deactivation': '💰・Modulo Disattivazione Grandi Rapine'
            };

            const moduleName = moduleNames[moduleType];
            const isActivation = moduleType.includes('activation');
            const bannerColor = isActivation ? '#10b981' : '#ef4444';
            const borderColor = isActivation ? '#10b981' : '#ef4444';

            // Se è attivazione pattuglie, mostra il modulo completo
            if (moduleType === 'patrol-activation') {
                return showPatrolActivationModule(moduleName, bannerColor, borderColor);
            }
            
            // Se è disattivazione pattuglie, mostra il modulo completo
            if (moduleType === 'patrol-deactivation') {
                return showPatrolDeactivationModule(moduleName, bannerColor, borderColor);
            }

            // Per gli altri moduli, mantieni il form semplice
            const form = `
                <div style="background: linear-gradient(135deg, ${bannerColor}20, ${bannerColor}10); border: 2px solid ${borderColor}; border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="color: ${borderColor}; margin: 0; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-${isActivation ? 'play-circle' : 'stop-circle'}"></i>
                        ${moduleName}
                    </h3>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Responsabile Turno</label>
                        <input type="text" id="shResponsible" placeholder="Nome responsabile" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Durata Turno (ore)</label>
                        <input type="number" id="shDuration" placeholder="8" min="1" max="24" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Note Aggiuntive</label>
                    <textarea id="shNotes" placeholder="Note per il turno..." rows="4" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease; resize: vertical;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'"></textarea>
                </div>
                
                <input type="hidden" id="shModuleType" value="${moduleType}">
            `;
            
            const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Annulla</button>
                <button class="btn btn-primary" onclick="saveShift()" style="background: linear-gradient(135deg, ${borderColor}, ${isActivation ? '#059669' : '#dc2626'});">
                    <i class="fas fa-save"></i> Salva ${isActivation ? 'Attivazione' : 'Disattivazione'}
                </button>
            `;
            
            UI.modal(`${moduleName}`, form, footer);
        }

        function showPatrolActivationModule(moduleName, bannerColor, borderColor) {
            // Tutti gli operatori per la selezione (gestito da)
            const allOps = operators;
            
            // Operatori disponibili per la selezione degli operatori in uscita
            const availableOps = operators.filter(op => op.status === 'Disponibile');

            const form = `
                <div style="background: linear-gradient(135deg, ${bannerColor}20, ${bannerColor}10); border: 2px solid ${borderColor}; border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="color: ${borderColor}; margin: 0; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-play-circle"></i>
                        ${moduleName}
                    </h3>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Gestito da -->
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Gestito da:</label>
                        <select id="patrolManager" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                            <option value="">Seleziona responsabile...</option>
                            ${allOps.map(op => `<option value="${op.id}">${op.name} - ${op.qualification}</option>`).join('')}
                            </select>
                        </div>

                    <!-- Orario di Attivazione -->
                        <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Orario di Attivazione Pattuglia:</label>
                        <input type="time" id="patrolTime" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                        </div>

                    <!-- Tipo di Intervento -->
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Tipo di Intervento:</label>
                        <select id="patrolType" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                            <option value="">Seleziona tipo intervento...</option>
                            <option value="pattugliamento-rapine">Pattugliamento Cittadino / Intervento Rapine</option>
                        </select>
                    </div>

                    <!-- Veicolo Utilizzato -->
                        <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Veicolo Utilizzato:</label>
                        <select id="patrolVehicle" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                            <option value="">Seleziona veicolo...</option>
                            <option value="jeep">Jeep Cherokee</option>
                            <option value="alfa">Alfa Romeo Giulietta </option>tili
                            </select>
                        </div>

                    <!-- Operatori in Uscita -->
                        <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Operatori in Uscita (min 2, max 2):</label>
                        <div id="operatorSelection" style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <select id="operator1" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'" onchange="updateOperator2Options()">
                                <option value="">Seleziona primo operatore...</option>
                                ${availableOps.map(op => `<option value="${op.id}">${op.name} - ${op.qualification}</option>`).join('')}
                            </select>
                            <select id="operator2" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                                <option value="">Seleziona secondo operatore...</option>
                                ${availableOps.map(op => `<option value="${op.id}">${op.name} - ${op.qualification}</option>`).join('')}
                            </select>
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem;">⚠️ È necessario selezionare esattamente 2 operatori</p>
                    </div>
                </div>
                
                <input type="hidden" id="shModuleType" value="patrol-activation">
            `;
            
            const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Annulla</button>
                <button class="btn btn-primary" onclick="savePatrolActivation()" style="background: linear-gradient(135deg, ${borderColor}, #059669);">
                    <i class="fas fa-save"></i> Salva Attivazione Pattuglia
                </button>
            `;
            
            UI.modal(`${moduleName}`, form, footer);
        }

        function updateOperator2Options() {
            const operator1Select = document.getElementById('operator1');
            const operator2Select = document.getElementById('operator2');
            const selectedOperator1 = operator1Select.value;
            
            // Reset operator2
            operator2Select.innerHTML = '<option value="">Seleziona secondo operatore...</option>';
            
            if (selectedOperator1) {
                // Filtra operatori escludendo quello già selezionato
                const allOps = operators.filter(op => op.status === 'Disponibile' && op.id != selectedOperator1);
                allOps.forEach(op => {
                    const option = document.createElement('option');
                    option.value = op.id;
                    option.textContent = `${op.name} - ${op.qualification}`;
                    operator2Select.appendChild(option);
                });
            } else {
                // Se nessun operatore selezionato, mostra tutti
                const allOps = operators.filter(op => op.status === 'Disponibile');
                allOps.forEach(op => {
                    const option = document.createElement('option');
                    option.value = op.id;
                    option.textContent = `${op.name} - ${op.qualification}`;
                    operator2Select.appendChild(option);
                });
            }
        }

        function showPatrolDeactivationModule(moduleName, bannerColor, borderColor) {
            // Trova gli operatori che sono attualmente in servizio (da attivazioni precedenti)
            const activeShifts = shifts.filter(shift => 
                shift.status === 'Attivo' && 
                (shift.moduleType === 'patrol-activation' || shift.type === 'patrol-activation')
            );
            const activeOperators = [];
            
            activeShifts.forEach(shift => {
                if (shift.operator1Id) {
                    const op1 = operators.find(op => op.id == shift.operator1Id);
                    if (op1) activeOperators.push(op1);
                }
                if (shift.operator2Id) {
                    const op2 = operators.find(op => op.id == shift.operator2Id);
                    if (op2) activeOperators.push(op2);
                }
            });

            // Rimuovi duplicati
            const uniqueActiveOperators = activeOperators.filter((op, index, self) => 
                index === self.findIndex(t => t.id === op.id)
            );

            // Se non ci sono operatori attivi, mostra tutti gli operatori disponibili
            let operatorsToShow = uniqueActiveOperators.length > 0 ? uniqueActiveOperators : operators.filter(op => op.status === 'Disponibile');
            
            // Ordina gli operatori in ordine discendente per grado (dal più alto al più basso)
            const roleOrder = {
                'Comandante Generale': 1,
                'Comandante': 2,
                'Vice Comandante': 3,
                'Sostituto Vice Comandante': 4,
                'Capitano': 5,
                'Caposquadra': 6,
                'Vice Caposquadra': 7,
                'Coordinatore': 8,
                'Tecnico Esperto': 9,
                'Tecnico Specializzato': 10
            };
            
            operatorsToShow.sort((a, b) => {
                const orderA = roleOrder[a.qualification] || 999;
                const orderB = roleOrder[b.qualification] || 999;
                return orderA - orderB; // Ordine crescente per mostrare i gradi più alti prima
            });

            const form = `
                <div style="background: linear-gradient(135deg, ${bannerColor}20, ${bannerColor}10); border: 2px solid ${borderColor}; border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="color: ${borderColor}; margin: 0; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-car"></i>
                        ${moduleName}
                    </h3>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Operatori in Rientro -->
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Operatori in Rientro (min 2, max 2):</label>
                        <div id="deactivationOperatorSelection" style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <select id="deactivationOperator1" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'" onchange="updateDeactivationOperator2Options()">
                                <option value="">Seleziona primo operatore...</option>
                                ${operatorsToShow.map(op => `<option value="${op.id}">${op.name} - ${op.qualification}</option>`).join('')}
                            </select>
                            <select id="deactivationOperator2" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                                <option value="">Seleziona secondo operatore...</option>
                                ${operatorsToShow.map(op => `<option value="${op.id}">${op.name} - ${op.qualification}</option>`).join('')}
                            </select>
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem;">⚠️ Seleziona gli operatori che stanno rientrando dall'attivazione precedente</p>
                    </div>

                    <!-- Orario di Disattivazione -->
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Orario di Disattivazione Pattuglia:</label>
                        <input type="time" id="deactivationTime" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                    </div>

                    <!-- Calcolo Durata -->
                    <div id="durationCalculation" style="background: rgba(255, 255, 255, 0.03); border-radius: 0.75rem; padding: 1rem; border: 1px solid rgba(255, 255, 255, 0.08); display: none;">
                        <h4 style="color: var(--text-primary); margin: 0 0 0.75rem 0; font-size: 1rem; font-weight: 600;">📊 Calcolo Durata Attivazione</h4>
                        <div id="durationDetails" style="color: var(--text-muted); font-size: 0.875rem;"></div>
                    </div>
                </div>
                
                <input type="hidden" id="shModuleType" value="patrol-deactivation">
            `;
            
            const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Annulla</button>
                <button class="btn btn-primary" onclick="savePatrolDeactivation()" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                    <i class="fas fa-save"></i> Salva Disattivazione Pattuglia
                </button>
            `;
            
            UI.modal(`${moduleName}`, form, footer);
        }

        function updateDeactivationOperator2Options() {
            const operator1Select = document.getElementById('deactivationOperator1');
            const operator2Select = document.getElementById('deactivationOperator2');
            const selectedOperator1 = operator1Select.value;
            
            // Reset operator2
            operator2Select.innerHTML = '<option value="">Seleziona secondo operatore...</option>';
            
            // Trova gli operatori attivi (stessa logica della funzione principale)
            const activeShifts = shifts.filter(shift => 
                shift.status === 'Attivo' && 
                (shift.moduleType === 'patrol-activation' || shift.type === 'patrol-activation')
            );
            const activeOperators = [];
            
            activeShifts.forEach(shift => {
                if (shift.operator1Id) {
                    const op1 = operators.find(op => op.id == shift.operator1Id);
                    if (op1) activeOperators.push(op1);
                }
                if (shift.operator2Id) {
                    const op2 = operators.find(op => op.id == shift.operator2Id);
                    if (op2) activeOperators.push(op2);
                }
            });

            // Rimuovi duplicati
            const uniqueActiveOperators = activeOperators.filter((op, index, self) => 
                index === self.findIndex(t => t.id === op.id)
            );

            // Se non ci sono operatori attivi, usa tutti gli operatori disponibili
            let operatorsToShow = uniqueActiveOperators.length > 0 ? uniqueActiveOperators : operators.filter(op => op.status === 'Disponibile');
            
            // Ordina gli operatori in ordine discendente per grado (stessa logica della funzione principale)
            const roleOrder = {
                'Comandante Generale': 1,
                'Comandante': 2,
                'Vice Comandante': 3,
                'Sostituto Vice Comandante': 4,
                'Capitano': 5,
                'Caposquadra': 6,
                'Vice Caposquadra': 7,
                'Coordinatore': 8,
                'Tecnico Esperto': 9,
                'Tecnico Specializzato': 10
            };
            
            operatorsToShow.sort((a, b) => {
                const orderA = roleOrder[a.qualification] || 999;
                const orderB = roleOrder[b.qualification] || 999;
                return orderA - orderB; // Ordine crescente per mostrare i gradi più alti prima
            });
            
            // Filtra escludendo l'operatore già selezionato
            const filteredOperators = operatorsToShow.filter(op => op.id != selectedOperator1);
            
            filteredOperators.forEach(op => {
                const option = document.createElement('option');
                option.value = op.id;
                option.textContent = `${op.name} - ${op.qualification}`;
                operator2Select.appendChild(option);
            });
        }

        function savePatrolActivation() {
            const managerId = document.getElementById('patrolManager')?.value;
            const patrolTime = document.getElementById('patrolTime')?.value;
            const patrolType = document.getElementById('patrolType')?.value;
            const patrolVehicle = document.getElementById('patrolVehicle')?.value;
            const operator1Id = document.getElementById('operator1')?.value;
            const operator2Id = document.getElementById('operator2')?.value;

            // Validazione campi obbligatori
            if (!managerId || !patrolTime || !patrolType || !patrolVehicle || !operator1Id || !operator2Id) {
                UI.notify('⚠️ Compila tutti i campi obbligatori!', 'error', '❌ Errore Validazione');
                return;
            }

            // Validazione operatori diversi
            if (operator1Id === operator2Id) {
                UI.notify('⚠️ Gli operatori devono essere diversi!', 'error', '❌ Errore Validazione');
                return;
            }

            // Trova i dati degli operatori
            const manager = operators.find(op => op.id == managerId);
            const operator1 = operators.find(op => op.id == operator1Id);
            const operator2 = operators.find(op => op.id == operator2Id);

            if (!manager || !operator1 || !operator2) {
                UI.notify('⚠️ Errore nel recupero dati operatori!', 'error', '❌ Errore');
                return;
            }

            // Mappa dei tipi di intervento
            const patrolTypes = {
                'pattugliamento-rapine': 'Pattugliamento Cittadino/Intervento Rapine'
            };

            // Mappa dei veicoli
            const vehicles = {
                'jeep': 'Jeep Cherokee',
                'alfa': 'Alfa Romeo Giulietta'
            };

            // Crea il nuovo turno
            const newShift = {
                id: Date.now(),
                moduleType: 'patrol-activation',
                status: 'Attivo',
                managerId: managerId,
                managerName: manager.name,
                managerQualification: manager.qualification,
                patrolTime: patrolTime,
                patrolType: patrolType,
                patrolTypeName: patrolTypes[patrolType],
                patrolVehicle: patrolVehicle,
                patrolVehicleName: vehicles[patrolVehicle],
                operator1Id: operator1Id,
                operator1Name: operator1.name,
                operator1Qualification: operator1.qualification,
                operator2Id: operator2Id,
                operator2Name: operator2.name,
                operator2Qualification: operator2.qualification,
                createdAt: new Date().toISOString(),
                createdDate: new Date().toLocaleDateString('it-IT')
            };

            // Aggiungi il turno all'array
            shifts.push(newShift);
            
            // Salva nel localStorage
            saveShifts();

            UI.loading('Salvataggio attivazione pattuglia...', true);
            
            setTimeout(() => {
                UI.loading('', false);
                UI.notify(`✅ Attivazione pattuglia salvata con successo!\\n\\nGestito da: ${manager.name}\\nOrario: ${patrolTime}\\nTipo: ${patrolTypes[patrolType]}\\nVeicolo: ${vehicles[patrolVehicle]}\\nOperatori: ${operator1.name}, ${operator2.name}`, 'success', '🚓 Attivazione Completata');
                UI.closeModal();
                
                // Ricarica pagina turni
                setTimeout(() => loadPage('shifts'), 500);
            }, 1500);
        }

        function savePatrolDeactivation() {
            const operator1Id = document.getElementById('deactivationOperator1')?.value;
            const operator2Id = document.getElementById('deactivationOperator2')?.value;
            const deactivationTime = document.getElementById('deactivationTime')?.value;

            // Validazione campi obbligatori
            if (!operator1Id || !operator2Id || !deactivationTime) {
                UI.notify('⚠️ Compila tutti i campi obbligatori!', 'error', '❌ Errore Validazione');
                return;
            }

            // Validazione operatori diversi
            if (operator1Id === operator2Id) {
                UI.notify('⚠️ Gli operatori devono essere diversi!', 'error', '❌ Errore Validazione');
                return;
            }

            // Trova i dati degli operatori
            const operator1 = operators.find(op => op.id == operator1Id);
            const operator2 = operators.find(op => op.id == operator2Id);

            if (!operator1 || !operator2) {
                UI.notify('⚠️ Errore nel recupero dati operatori!', 'error', '❌ Errore');
                return;
            }

            // Trova l'attivazione precedente per questi operatori
            const activeShift = shifts.find(shift => 
                shift.status === 'Attivo' && 
                (shift.moduleType === 'patrol-activation' || shift.type === 'patrol-activation') &&
                ((shift.operator1Id == operator1Id && shift.operator2Id == operator2Id) ||
                 (shift.operator1Id == operator2Id && shift.operator2Id == operator1Id))
            );

            // Se non c'è un'attivazione precedente, crea una disattivazione standalone
            if (!activeShift) {
                UI.notify('⚠️ Nessuna attivazione precedente trovata per questi operatori. Creazione disattivazione standalone...', 'warning', '⚠️ Avviso');
                
                // Crea una disattivazione standalone senza calcolo durata
                const newShift = {
                    id: Date.now(),
                    moduleType: 'patrol-deactivation',
                    status: 'Completato',
                    operator1Id: operator1Id,
                    operator1Name: operator1.name,
                    operator1Qualification: operator1.qualification,
                    operator2Id: operator2Id,
                    operator2Name: operator2.name,
                    operator2Qualification: operator2.qualification,
                    deactivationTime: deactivationTime,
                    duration: 'N/A',
                    createdDate: new Date().toLocaleDateString('it-IT'),
                    createdAt: new Date().toISOString()
                };

                shifts.push(newShift);
                saveShifts();

                UI.loading('Salvataggio disattivazione...', true);
                
                setTimeout(() => {
                    UI.loading('', false);
                    UI.notify(`✅ Disattivazione pattuglia salvata con successo!\\n\\nOperatori: ${operator1.name}, ${operator2.name}\\nOrario Disattivazione: ${deactivationTime}\\n\\nNota: Nessuna attivazione precedente trovata.`, 'success', '🚓 Disattivazione Completata');
                    UI.closeModal();
                    
                    setTimeout(() => loadPage('shifts'), 500);
                }, 1500);
                
                return;
            }

            // Calcola la durata dell'attivazione
            const activationTime = activeShift.patrolTime;
            
            // Converte la data italiana (dd/mm/yyyy) in formato ISO
            const dateParts = activeShift.createdDate.split('/');
            const isoDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
            
            const activationDateTime = new Date(`${isoDate}T${activationTime}:00`);
            const deactivationDateTime = new Date(`${isoDate}T${deactivationTime}:00`);
            
            // Se l'orario di disattivazione è precedente all'attivazione, assumiamo che sia il giorno dopo
            if (deactivationDateTime < activationDateTime) {
                deactivationDateTime.setDate(deactivationDateTime.getDate() + 1);
            }
            
            const durationMs = deactivationDateTime - activationDateTime;
            
            // Controlla se il calcolo è valido
            let durationText, durationHours, durationMinutes;
            if (isNaN(durationMs) || durationMs < 0) {
                durationText = 'N/A';
                durationHours = 0;
                durationMinutes = 0;
            } else {
                durationHours = Math.floor(durationMs / (1000 * 60 * 60));
                durationMinutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                durationText = `${durationHours}h ${durationMinutes}m`;
            }

            // Crea il nuovo turno di disattivazione
            const newShift = {
                id: Date.now(),
                moduleType: 'patrol-deactivation',
                status: 'Completato',
                operator1Id: operator1Id,
                operator1Name: operator1.name,
                operator1Qualification: operator1.qualification,
                operator2Id: operator2Id,
                operator2Name: operator2.name,
                operator2Qualification: operator2.qualification,
                deactivationTime: deactivationTime,
                activationTime: activationTime,
                duration: durationText,
                durationHours: durationHours,
                durationMinutes: durationMinutes,
                relatedActivationId: activeShift.id,
                createdDate: activeShift.createdDate,
                createdAt: new Date().toISOString()
            };

            // Aggiorna lo stato dell'attivazione precedente
            activeShift.status = 'Completato';
            activeShift.deactivationTime = deactivationTime;
            activeShift.duration = durationText;
            activeShift.durationHours = durationHours;
            activeShift.durationMinutes = durationMinutes;
            activeShift.completedAt = new Date().toISOString();

            // Aggiungi il nuovo turno
            shifts.push(newShift);

            // Salva nel localStorage
            saveShifts();

            UI.loading('Salvataggio disattivazione...', true);
            
            setTimeout(() => {
                UI.loading('', false);
                UI.notify(`✅ Disattivazione pattuglia salvata con successo!\\n\\nOperatori: ${operator1.name}, ${operator2.name}\\nOrario Disattivazione: ${deactivationTime}\\nDurata Totale: ${durationText}\\n\\nL'attivazione precedente è stata completata automaticamente.`, 'success', '🚓 Disattivazione Completata');
                UI.closeModal();
                
                // Ricarica pagina turni
                setTimeout(() => loadPage('shifts'), 500);
            }, 1500);
        }

        function editShift(shiftId) {
            const shift = shifts.find(s => s.id === shiftId);
            if (!shift) {
                UI.notify('⚠️ Turno non trovato!', 'error', '❌ Errore');
                return;
            }

            // Tutti gli operatori per la selezione (gestito da)
            const allOps = operators;
            
            // Operatori disponibili per la selezione degli operatori in uscita
            const availableOps = operators.filter(op => op.status === 'Disponibile');

            const form = `
                <div style="background: linear-gradient(135deg, #3b82f620, #3b82f610); border: 2px solid #3b82f6; border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="color: #3b82f6; margin: 0; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-edit"></i>
                        Modifica Turno Pattuglia
                    </h3>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Gestito da -->
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Gestito da:</label>
                        <select id="editPatrolManager" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                            <option value="">Seleziona responsabile...</option>
                            ${allOps.map(op => `<option value="${op.id}" ${op.id == shift.managerId ? 'selected' : ''}>${op.name} - ${op.qualification}</option>`).join('')}
                        </select>
                    </div>

                    <!-- Orario di Attivazione -->
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Orario di Attivazione Pattuglia:</label>
                        <input type="time" id="editPatrolTime" value="${shift.patrolTime}" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                    </div>

                    <!-- Tipo di Intervento -->
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Tipo di Intervento:</label>
                        <select id="editPatrolType" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                            <option value="">Seleziona tipo intervento...</option>
                            <option value="pattugliamento-rapine" ${shift.patrolType === 'pattugliamento-rapine' ? 'selected' : ''}>Pattugliamento Cittadino/Intervento Rapine</option>
                        </select>
                    </div>

                    <!-- Veicolo Utilizzato -->
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Veicolo Utilizzato:</label>
                        <select id="editPatrolVehicle" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                            <option value="">Seleziona veicolo...</option>
                            <option value="jeep" ${shift.patrolVehicle === 'jeep' ? 'selected' : ''}>Jeep Cherokee</option>
                            <option value="alfa" ${shift.patrolVehicle === 'alfa' ? 'selected' : ''}>Alfa Romeo Giulietta</option>
                        </select>
                    </div>

                    <!-- Operatori in Uscita -->
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Operatori in Uscita (min 2, max 2):</label>
                        <div id="editOperatorSelection" style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <select id="editOperator1" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'" onchange="updateEditOperator2Options()">
                                <option value="">Seleziona primo operatore...</option>
                                ${availableOps.map(op => `<option value="${op.id}" ${op.id == shift.operator1Id ? 'selected' : ''}>${op.name} - ${op.qualification}</option>`).join('')}
                            </select>
                            <select id="editOperator2" style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                                <option value="">Seleziona secondo operatore...</option>
                                ${availableOps.map(op => `<option value="${op.id}" ${op.id == shift.operator2Id ? 'selected' : ''}>${op.name} - ${op.qualification}</option>`).join('')}
                            </select>
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem;">⚠️ È necessario selezionare esattamente 2 operatori</p>
                    </div>
                </div>
                
                <input type="hidden" id="editShiftId" value="${shiftId}">
            `;
            
            const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Annulla</button>
                <button class="btn btn-primary" onclick="updateShift()" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                    <i class="fas fa-save"></i> Salva Modifiche
                </button>
            `;
            
            UI.modal('✏️ Modifica Turno Pattuglia', form, footer);
        }

        function updateEditOperator2Options() {
            const operator1Select = document.getElementById('editOperator1');
            const operator2Select = document.getElementById('editOperator2');
            const selectedOperator1 = operator1Select.value;
            
            // Reset operator2
            operator2Select.innerHTML = '<option value="">Seleziona secondo operatore...</option>';
            
            if (selectedOperator1) {
                // Filtra operatori escludendo quello già selezionato
                const allOps = operators.filter(op => op.status === 'Disponibile' && op.id != selectedOperator1);
                allOps.forEach(op => {
                    const option = document.createElement('option');
                    option.value = op.id;
                    option.textContent = `${op.name} - ${op.qualification}`;
                    operator2Select.appendChild(option);
                });
            } else {
                // Se nessun operatore selezionato, mostra tutti
                const allOps = operators.filter(op => op.status === 'Disponibile');
                allOps.forEach(op => {
                    const option = document.createElement('option');
                    option.value = op.id;
                    option.textContent = `${op.name} - ${op.qualification}`;
                    operator2Select.appendChild(option);
                });
            }
        }

        function updateShift() {
            const shiftId = document.getElementById('editShiftId')?.value;
            const managerId = document.getElementById('editPatrolManager')?.value;
            const patrolTime = document.getElementById('editPatrolTime')?.value;
            const patrolType = document.getElementById('editPatrolType')?.value;
            const patrolVehicle = document.getElementById('editPatrolVehicle')?.value;
            const operator1Id = document.getElementById('editOperator1')?.value;
            const operator2Id = document.getElementById('editOperator2')?.value;

            // Validazione campi obbligatori
            if (!managerId || !patrolTime || !patrolType || !patrolVehicle || !operator1Id || !operator2Id) {
                UI.notify('⚠️ Compila tutti i campi obbligatori!', 'error', '❌ Errore Validazione');
                return;
            }

            // Validazione operatori diversi
            if (operator1Id === operator2Id) {
                UI.notify('⚠️ Gli operatori devono essere diversi!', 'error', '❌ Errore Validazione');
                return;
            }

            // Trova i dati degli operatori
            const manager = operators.find(op => op.id == managerId);
            const operator1 = operators.find(op => op.id == operator1Id);
            const operator2 = operators.find(op => op.id == operator2Id);

            if (!manager || !operator1 || !operator2) {
                UI.notify('⚠️ Errore nel recupero dati operatori!', 'error', '❌ Errore');
                return;
            }

            // Mappa dei tipi di intervento
            const patrolTypes = {
                'pattugliamento-rapine': 'Pattugliamento Cittadino/Intervento Rapine'
            };

            // Mappa dei veicoli
            const vehicles = {
                'jeep': 'Jeep Cherokee',
                'alfa': 'Alfa Romeo Giulietta'
            };

            // Trova il turno da aggiornare
            const shiftIndex = shifts.findIndex(s => s.id == shiftId);
            if (shiftIndex === -1) {
                UI.notify('⚠️ Turno non trovato!', 'error', '❌ Errore');
                return;
            }

            // Aggiorna il turno
            shifts[shiftIndex] = {
                ...shifts[shiftIndex],
                managerId: managerId,
                managerName: manager.name,
                patrolTime: patrolTime,
                patrolType: patrolType,
                patrolTypeName: patrolTypes[patrolType],
                patrolVehicle: patrolVehicle,
                patrolVehicleName: vehicles[patrolVehicle],
                operator1Id: operator1Id,
                operator1Name: operator1.name,
                operator2Id: operator2Id,
                operator2Name: operator2.name,
                updatedAt: new Date().toISOString()
            };

            // Salva nel localStorage
            saveShifts();

            UI.loading('Salvataggio modifiche...', true);
            
            setTimeout(() => {
                UI.loading('', false);
                UI.notify(`✅ Turno modificato con successo!\\n\\nGestito da: ${manager.name}\\nOrario: ${patrolTime}\\nTipo: ${patrolTypes[patrolType]}\\nVeicolo: ${vehicles[patrolVehicle]}\\nOperatori: ${operator1.name}, ${operator2.name}`, 'success', '✏️ Modifiche Salvate');
                UI.closeModal();
                
                // Ricarica pagina turni
                setTimeout(() => loadPage('shifts'), 500);
            }, 1500);
        }

        function saveShift() {
            const type = document.getElementById('shType')?.value;
            const date = document.getElementById('shDate')?.value;
            const team = document.getElementById('shTeam')?.value;
            const leader = document.getElementById('shLeader')?.value;
            const moduleType = document.getElementById('shModuleType')?.value;
            
            if (!type || !date || !team || !leader || !moduleType) {
                UI.notify('⚠️ Compila tutti i campi!', 'error');
                return;
            }
            
            const moduleNames = {
                'patrol-activation': 'Modulo Attivazione Pattuglie',
                'patrol-deactivation': 'Modulo Disattivazione Pattuglie', 
                'heist-activation': 'Modulo Attivazione Grandi Rapine',
                'heist-deactivation': 'Modulo Disattivazione Grandi Rapine'
            };
            
            UI.loading('Salvataggio turno...', true);
            setTimeout(() => {
                UI.loading('', false);
                const typeName = type === 'morning' ? 'Mattina' : type === 'afternoon' ? 'Pomeriggio' : 'Notte';
                const moduleName = moduleNames[moduleType];
                UI.notify(`✅ Turno ${typeName} - ${moduleName} - Squadra ${team} aggiunto!`, 'success');
                UI.closeModal();
                // Ricarica pagina con animazione
                setTimeout(() => loadPage('shifts'), 500);
            }, 1500);
        }

        // ========== INIT ==========
        window.addEventListener('load', () => {
            // Simula login automatico per test
            setTimeout(() => {
                const loginPage = document.getElementById('loginPage');
                loginPage.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
                loginPage.style.opacity = '0';
                loginPage.style.transform = 'scale(0.9)';
                
                setTimeout(() => {
                    loginPage.style.display = 'none';
                showDashboard({ 
                    username: 'dxrk.ryze', 
                    discriminator: '0000',
                    id: ADMIN_ID 
                });
                }, 400);
            }, 500);
        });

        // Chiudi dropdown quando si clicca fuori
        document.addEventListener('click', (e) => {
            const userProfile = document.querySelector('.user-profile');
            const dropdown = document.querySelector('.user-dropdown');
            
            if (userProfile && dropdown && !userProfile.contains(e.target)) {
                dropdown.classList.remove('active');
                const chevron = userProfile.querySelector('i.fa-chevron-down');
                if (chevron) {
                    chevron.style.transform = 'rotate(0deg)';
                }
            }
        });

        // Aggiungi keyframes spin e altre animazioni
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin { 
                from { transform: rotate(0deg); } 
                to { transform: rotate(360deg); } 
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes slideInLeft {
                from { opacity: 0; transform: translateX(-50px); }
                to { opacity: 1; transform: translateX(0); }
            }
            @keyframes slideInRight {
                from { opacity: 0; transform: translateX(50px); }
                to { opacity: 1; transform: translateX(0); }
            }
            @keyframes bounceIn {
                0% { opacity: 0; transform: scale(0.3); }
                50% { opacity: 1; transform: scale(1.05); }
                70% { transform: scale(0.9); }
                100% { opacity: 1; transform: scale(1); }
            }
        `;
        document.head.appendChild(style);

        // ========== SISTEMA DROPDOWN PERSONALIZZATO ==========
        
        // Funzione per creare un dropdown personalizzato
        function createCustomDropdown(id, placeholder, options, selectedValue = '', onSelect = null) {
            const dropdownHTML = 
                '<div class="custom-dropdown" id="' + id + '-dropdown">' +
                    '<div class="dropdown-trigger" onclick="toggleDropdown(\'' + id + '\')" tabindex="0">' +
                        '<div class="dropdown-text" id="' + id + '-text">' + placeholder + '</div>' +
                        '<i class="fas fa-chevron-down dropdown-arrow"></i>' +
                    '</div>' +
                    '<div class="dropdown-menu" id="' + id + '-menu">' +
                        options.map(option => 
                            '<div class="dropdown-item" ' +
                                 'data-value="' + option.value + '" ' +
                                 'onclick="selectDropdownOption(\'' + id + '\', \'' + option.value + '\', \'' + option.text + '\', \'' + (option.icon || '') + '\', \'' + (option.qualification || '') + '\')"' +
                                 (selectedValue === option.value ? ' class="selected"' : '') + '>' +
                                (option.icon ? '<span class="dropdown-item-icon">' + option.icon + '</span>' : '') +
                                '<div class="dropdown-item-text">' +
                                    option.text +
                                    (option.qualification ? '<div class="dropdown-item-qualification">' + option.qualification + '</div>' : '') +
                                '</div>' +
                            '</div>'
                        ).join('') +
                    '</div>' +
                '</div>';
            
            return dropdownHTML;
        }

        // Funzione per aprire/chiudere dropdown
        function toggleDropdown(id) {
            const trigger = document.getElementById(id + '-dropdown').querySelector('.dropdown-trigger');
            const menu = document.getElementById(id + '-menu');
            
            // Chiudi tutti gli altri dropdown
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                if (menu.id !== id + '-menu') {
                    menu.classList.remove('show');
                    menu.previousElementSibling.classList.remove('open');
                }
            });
            
            // Toggle dropdown corrente
            trigger.classList.toggle('open');
            menu.classList.toggle('show');
        }

        // Funzione per selezionare un'opzione
        function selectDropdownOption(id, value, text, icon, qualification) {
            const trigger = document.getElementById(id + '-dropdown').querySelector('.dropdown-trigger');
            const menu = document.getElementById(`${id}-menu');
            const textElement = document.getElementById(id + '-text');
            
            // Aggiorna testo visualizzato
            textElement.innerHTML = 
                (icon ? '<span style="margin-right: 0.5rem;">' + icon + '</span>' : '') +
                text +
                (qualification ? '<span style="color: #94a3b8; font-size: 0.75rem; margin-left: 0.5rem;">• ' + qualification + '</span>' : '');
            
            // Aggiorna stato selezionato
            menu.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('selected');
                if (item.dataset.value === value) {
                    item.classList.add('selected');
                }
            });
            
            // Chiudi dropdown
            trigger.classList.remove('open');
            menu.classList.remove('show');
            
            // Trigger callback se fornito
            if (window['on' + id + 'Select']) {
                window['on' + id + 'Select'](value, text, icon, qualification);
            }
        }

        // Funzione per chiudere tutti i dropdown quando si clicca fuori
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.custom-dropdown')) {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                    menu.previousElementSibling.classList.remove('open');
                });
            }
        });

        // Funzione per gestire la navigazione con tastiera
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                    menu.previousElementSibling.classList.remove('open');
                });
            }
        });

        // ========== INIZIALIZZAZIONE SISTEMA ==========
        // Carica dati salvati all'avvio
        function initializeSystem() {
            console.log('🔄 Inizializzazione sistema...');
            
            // Carica operatori salvati
            if (loadOperators()) {
                console.log('✅ Caricati ' + operators.length + ' operatori dal localStorage');
            } else {
                console.log('ℹ️ Nessun operatore salvato trovato');
            }
            
            // Carica notifiche salvate
            if (loadNotifications()) {
                console.log('✅ Caricate ' + notifications.length + ' notifiche dal localStorage');
            } else {
                console.log('ℹ️ Nessuna notifica salvata trovata');
            }
            
            // Mostra notifica di benvenuto se ci sono operatori
            if (operators.length > 0) {
                setTimeout(() => {
                    UI.notify('Benvenuto! Sistema caricato con ' + operators.length + ' operatori', 'success', '🚀 Sistema Pronto');
                }, 1000);
            }
        }

        // ========== INIZIALIZZAZIONE AUTOMATICA ==========
        // Assicurati che il DOM sia caricato prima di inizializzare
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSystem);
        } else {
            initializeSystem();
        }

        console.log('✅ Sistema caricato - VERSIONE PULITA');
    </script>
</body>
</html>
