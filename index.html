<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UOPI Dashboard ‚Ä¢ Sistema Operativo</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <meta name="color-scheme" content="dark">
  <style>
    :root{
      --bg1:#0a0f1d; --bg2:#0c1426; --panel:#0e1a34;
      --stroke:#1b2a4a; --text:#e6ebf4; --muted:#9fb0cc; --strong:#f8fbff;
      --p1:#4f8cff; --p2:#7a5cff; --acc:#1ee4ff; --ok:#1ad1a5; --warn:#ffb547; --err:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1100px 540px at -10% -10%,#0b1540 0%,transparent 60%),
        radial-gradient(900px 520px at 120% 0%,#081233 0%,transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
    }

    /* Header */
    .top{position:sticky; top:0; z-index:50; backdrop-filter:blur(12px);
      background:linear-gradient(180deg,rgba(10,15,29,.85),rgba(10,15,29,.35));
      border-bottom:1px solid var(--stroke)}
    .tb{max-width:1280px; margin:0 auto; padding:12px 18px; display:flex; align-items:center; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800}
    .brand i{background:linear-gradient(135deg,var(--p2),var(--acc)); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
    .sp{flex:1}
    .btn{background:#0f1a34; border:1px solid var(--stroke); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; transition:.2s; display:inline-flex; align-items:center; gap:10px}
    .btn:hover{border-color:var(--p1); box-shadow:0 0 0 3px rgba(79,140,255,.25)}
    .btn.pri{background:linear-gradient(135deg,var(--p1),var(--p2)); border-color:transparent}

    /* Tabs */
    .tabs{max-width:1280px; margin:0 auto; padding:18px}
    .tabbar{display:flex; gap:10px; background:rgba(255,255,255,.03); border:1px solid var(--stroke); border-radius:12px; padding:6px}
    .tab{flex:1; text-align:center; padding:10px; border-radius:8px; cursor:pointer; color:var(--muted)}
    .tab.active{color:var(--strong); background:linear-gradient(135deg,rgba(79,140,255,.12),rgba(30,228,255,.10)); border:1px solid rgba(79,140,255,.35)}

    /* Main wrapper */
    .wrap{max-width:1280px; margin:0 auto; padding:20px 18px}

    /* Panels */
    .panel{display:none}
    .panel.active{display:block}

    /* Cards */
    .hero{display:grid; grid-template-columns:1.2fr .8fr; gap:22px}
    .card{background:linear-gradient(180deg,#0f1c3a,#0b1730); border:1px solid var(--stroke); border-radius:16px; padding:24px; position:relative; overflow:hidden}
    .card:before{content:""; position:absolute; inset:-1px;
      background:radial-gradient(500px 230px at 8% -10%,rgba(79,140,255,.12),transparent 60%),
                 radial-gradient(600px 230px at 110% -20%,rgba(30,228,255,.12),transparent 60%)}
    .h1{font-size:36px; font-weight:800; margin:0 0 8px; background:linear-gradient(135deg,var(--p1),var(--acc)); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
    .sub{color:var(--muted); margin:0 0 18px}
    .actions{display:flex; gap:10px; flex-wrap:wrap}

    .stats{margin-top:18px; display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    .stat{background:#0e1a34; border:1px solid var(--stroke); border-radius:12px; padding:14px; text-align:center}
    .n{font-size:24px; font-weight:800; color:var(--p1)}
    .l{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.4px}

    .sect{margin-top:30px}
    .sect h2{margin:0 0 12px; font-size:22px}
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
    .mod{background:linear-gradient(180deg,#0f1c3a,#0b1730); border:1px solid var(--stroke); border-radius:16px; padding:18px; cursor:pointer; transition:.25s; position:relative}
    .mod:hover{transform:translateY(-4px); border-color:var(--p1)}
    .ic{width:58px; height:58px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; background:linear-gradient(135deg,var(--p1),var(--acc)); margin-bottom:12px}
    .mt{margin:0 0 6px; font-weight:700}
    .md{margin:0; color:var(--muted)}

    /* Login widgets */
    .login-actions{display:grid; gap:10px}
    .alert{background:rgba(255,255,255,.04); border:1px solid var(--stroke); border-radius:12px; padding:12px; color:var(--muted); font-size:14px}

    /* Modal */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(7,11,23,.86); backdrop-filter:blur(8px); z-index:100}
    .modal.show{display:flex}
    .box{width:min(680px,92vw); background:#0f1c3a; border:1px solid var(--stroke); border-radius:16px; overflow:hidden}
    .bxh{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--stroke)}
    .bxt{font-weight:800}
    .bxc{padding:18px; color:var(--muted); line-height:1.6}
    .x{background:transparent; border:none; color:var(--muted); font-size:22px; cursor:pointer}

    /* Responsive */
    @media(max-width:980px){ 
      .hero{grid-template-columns:1fr} 
      .stats{grid-template-columns:repeat(2,1fr)} 
      .grid{grid-template-columns:1fr 1fr} 
    }
    @media(max-width:640px){ 
      .h1{font-size:28px} 
      .grid{grid-template-columns:1fr} 
    }
  </style>
</head>
<body>
  <header class="top">
    <div class="tb">
      <div class="brand"><i class="fa-solid fa-shield"></i>UOPI Dashboard</div>
      <div class="sp"></div>
      <button class="btn" onclick="openModal('help')"><i class="fa-regular fa-circle-question"></i> Guida</button>
      <button class="btn pri" id="top-login-btn"><i class="fa-brands fa-discord"></i> Login Discord</button>
      <button class="btn" id="top-logout-btn" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tabbar">
      <div class="tab active" id="tab-login">Login</div>
      <div class="tab" id="tab-dashboard">Dashboard</div>
    </div>
  </div>

  <main class="wrap">
    <!-- Panel: LOGIN -->
    <section id="panel-login" class="panel active">
      <div class="hero">
        <div class="card">
          <h1 class="h1">Accedi a UOPI</h1>
          <p class="sub">Autenticazione tramite Discord OAuth2 con redirect sicuro. Dopo il login verrai indirizzato alla Dashboard.</p>
          <div class="login-actions">
            <button class="btn pri" id="login-btn"><i class="fa-brands fa-discord"></i> Accedi con Discord</button>
            <button class="btn" id="demo-btn"><i class="fa-regular fa-user"></i> Modalit√† Demo</button>
            <div class="alert"><i class="fa-regular fa-circle-check" style="color:var(--ok)"></i> Sicurezza: il Client Secret non √® nel client. Serve un piccolo proxy per scambiare il code con il token.</div>
            <small style="color:var(--muted)">Client ID configurato: 1387801645743869982</small>
          </div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 10px">Anteprima Funzionalit√†</h3>
          <div class="stats">
            <div class="stat"><div class="n" id="ls1">28</div><div class="l">Operatori</div></div>
            <div class="stat"><div class="n" id="ls2">12</div><div class="l">Interventi</div></div>
            <div class="stat"><div class="n" id="ls3">147</div><div class="l">Report</div></div>
            <div class="stat"><div class="n" id="ls4">99%</div><div class="l">Efficienza</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Panel: DASHBOARD -->
    <section id="panel-dashboard" class="panel">
      <div class="hero">
        <div class="card">
          <h1 class="h1">Sistema UOPI</h1>
          <p class="sub">Unit√† Operative Polizia Italiana ‚Ä¢ Dashboard Centralizzato</p>
          <div class="actions">
            <button class="btn pri" onclick="document.getElementById('moduli').scrollIntoView({behavior:'smooth'})"><i class="fa-solid fa-grip"></i> Apri moduli</button>
            <button class="btn" onclick="openModal('changelog')"><i class="fa-solid fa-bolt"></i> Novit√†</button>
          </div>
          <div class="stats">
            <div class="stat"><div class="n" id="st1">28</div><div class="l">Operatori Attivi</div></div>
            <div class="stat"><div class="n" id="st2">12</div><div class="l">Interventi</div></div>
            <div class="stat"><div class="n" id="st3">147</div><div class="l">Report Oggi</div></div>
            <div class="stat"><div class="n" id="st4">99%</div><div class="l">Efficienza</div></div>
          </div>
        </div>
        <div class="card" id="user-card">
          <h3 style="margin:0 0 8px">Profilo</h3>
          <p class="sub">Informazioni essenziali dell'utente autenticato.</p>
          <div id="user-info" class="alert">Nessuna sessione rilevata.</div>
          <div style="display:flex; gap:10px; margin-top:10px">
            <button class="btn" id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
          </div>
        </div>
      </div>

      <section class="sect" id="moduli">
        <h2>Moduli Operativi</h2>
        <div class="grid">
          <div class="mod" data-k="operators"><div class="ic"><i class="fa-solid fa-users"></i></div><h3 class="mt">üëÆ‚Äç‚ôÇÔ∏è Gestione Operatori</h3><p class="md">Turni, qualifiche, progressioni e assegnazioni territoriali.</p></div>
          <div class="mod" data-k="interventions"><div class="ic"><i class="fa-solid fa-triangle-exclamation"></i></div><h3 class="mt">üö® Centro Interventi</h3><p class="md">Coordinamento live, dispatch, priorit√† e tracciamento unit√†.</p></div>
          <div class="mod" data-k="equipment"><div class="ic"><i class="fa-solid fa-car"></i></div><h3 class="mt">üõ°Ô∏è Equipaggiamenti</h3><p class="md">Inventario mezzi e attrezzature, manutenzioni e disponibilit√†.</p></div>
          <div class="mod" data-k="reports"><div class="ic"><i class="fa-solid fa-chart-line"></i></div><h3 class="mt">üìä Analytics & Report</h3><p class="md">KPI operativi, statistiche territoriali e report personalizzati.</p></div>
          <div class="mod" data-k="comms"><div class="ic"><i class="fa-solid fa-satellite-dish"></i></div><h3 class="mt">üì° Comunicazioni</h3><p class="md">Messaggistica sicura, alert e coordinamento inter-forze.</p></div>
          <div class="mod" data-k="database"><div class="ic"><i class="fa-solid fa-database"></i></div><h3 class="mt">üóÉÔ∏è Database Centrale</h3><p class="md">Archivio centralizzato con ricerca avanzata e documenti operativi.</p></div>
        </div>
      </section>
    </section>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="box">
      <div class="bxh"><div class="bxt" id="mt">Dettagli</div><button class="x" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button></div>
      <div class="bxc" id="mb">...</div>
    </div>
  </div>

  <script>
    // CONFIG Discord OAuth
    const CONFIG = {
      discord: {
        client_id: '1387801645743869982',
        redirect_uri: 'https://ryze-glitch.github.io/uopi-dashboard/',
        scope: 'identify'
      }
    };

    // Tabs management
    const tabLogin = document.getElementById('tab-login');
    const tabDash = document.getElementById('tab-dashboard');
    const panelLogin = document.getElementById('panel-login');
    const panelDash = document.getElementById('panel-dashboard');

    function setTab(tab){
      if(tab==='login'){
        tabLogin.classList.add('active'); tabDash.classList.remove('active');
        panelLogin.classList.add('active'); panelDash.classList.remove('active');
      }else{
        tabDash.classList.add('active'); tabLogin.classList.remove('active');
        panelDash.classList.add('active'); panelLogin.classList.remove('active');
      }
    }

    tabLogin.addEventListener('click', ()=> setTab('login'));
    tabDash.addEventListener('click', ()=> {
      const sess = getSession();
      if(!sess){ setTab('login'); openModal('need-login'); return; }
      setTab('dashboard');
    });

    // Session management
    function setSession(data){ localStorage.setItem('uopi_session', JSON.stringify(data)); }
    function getSession(){ try{return JSON.parse(localStorage.getItem('uopi_session')||'null')}catch{return null} }
    function clearSession(){ localStorage.removeItem('uopi_session'); }

    // Discord OAuth
    function startDiscordOAuth(){
      const { client_id, redirect_uri, scope } = CONFIG.discord;
      const url = `https://discord.com/oauth2/authorize?response_type=code&client_id=${encodeURIComponent(client_id)}&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=${encodeURIComponent(scope)}`;
      window.location.href = url;
    }

    // Check URL params for OAuth code
    (function checkOAuthCode(){
      const params = new URLSearchParams(location.search);
      const code = params.get('code');
      if(code){
        // Per sicurezza, in produzione il code va scambiato con access_token via proxy server
        // Qui simuliamo un login demo
        const profile = { id:'oauth_user', username:'DiscordUser', avatar:null, role:'Operatore' };
        setSession({ access_token:'demo_token', user:profile });
        renderUser({ user:profile });
        setTab('dashboard');
        showTopLogout(true);
        history.replaceState({},'',location.pathname);
      }
    })();

    // Demo login
    function demoLogin(){
      const profile = { id:'demo', username:'DemoUser', avatar:null, role:'Comandante' };
      setSession({ access_token:'demo', user:profile });
      renderUser({ user:profile });
      setTab('dashboard');
      showTopLogout(true);
    }

    // UI Elements
    const loginBtn = document.getElementById('login-btn');
    const demoBtn = document.getElementById('demo-btn');
    const topLoginBtn = document.getElementById('top-login-btn');
    const topLogoutBtn = document.getElementById('top-logout-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userInfo = document.getElementById('user-info');

    loginBtn.addEventListener('click', startDiscordOAuth);
    topLoginBtn.addEventListener('click', startDiscordOAuth);
    demoBtn.addEventListener('click', demoLogin);

    function showTopLogout(state){
      topLogoutBtn.style.display = state ? 'inline-flex' : 'none';
      topLoginBtn.style.display = state ? 'none' : 'inline-flex';
    }

    logoutBtn.addEventListener('click', doLogout);
    topLogoutBtn.addEventListener('click', doLogout);
    function doLogout(){
      clearSession();
      userInfo.textContent = 'Nessuna sessione rilevata.';
      showTopLogout(false);
      setTab('login');
    }

    function renderUser(session){
      const u = session.user || {};
      const avatar = u.avatar ? `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png` : null;
      userInfo.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px">
          ${avatar ? `<img src="${avatar}" alt="avatar" style="width:44px;height:44px;border-radius:50%;border:2px solid var(--p1)">` : `<div style="width:44px;height:44px;border-radius:50%;background:var(--p1);display:flex;align-items:center;justify-content:center"><i class="fa-regular fa-user"></i></div>`}
          <div>
            <div style="font-weight:700">${u.username || 'Utente'}</div>
            <div style="color:var(--muted);font-size:12px">${u.role || 'Ruolo'}</div>
          </div>
        </div>
      `;
    }

    // Modal system
    const modal = document.getElementById('modal');
    const mt = document.getElementById('mt');
    const mb = document.getElementById('mb');

    function openModal(kind){
      const map = {
        'help':{t:'Guida Rapida', b:'Tab Login per autenticarsi con Discord. La Dashboard √® accessibile solo dopo il login. Usa Demo per test.'},
        'need-login':{t:'Autenticazione richiesta', b:'Aprire la scheda Login e autenticarsi con Discord prima di accedere alla Dashboard.'},
        'changelog':{t:'Novit√† v3.0', b:'UI moderna con tabs, gestione sessione, login Discord, profilo utente, moduli interattivi.'}
      };
      const x = map[kind] || {t:'Info', b:'Contenuto in sviluppo.'};
      mt.textContent = x.t; mb.textContent = x.b; modal.classList.add('show');
    }
    function closeModal(){ modal.classList.remove('show'); }
    modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

    // Module cards interaction
    document.querySelectorAll('.mod').forEach(c=>{
      c.addEventListener('click', ()=>{
        const title = c.querySelector('.mt').textContent;
        mt.textContent = title;
        mb.innerHTML = `<p>Anteprima del modulo <b>${title}</b> con interfaccia completa.</p>
        <ul style="margin:0;padding-left:18px;color:var(--muted)">
          <li>Toolbar con ricerca e filtri</li>
          <li>Tabella virtualizzata ad alte prestazioni</li>
          <li>Drawer laterale per dettagli</li>
          <li>Azioni: crea, modifica, archivia, esporta</li>
        </ul>`;
        modal.classList.add('show');
      });
    });

    // Check for existing session on load
    (function initSession(){
      const sess = getSession();
      if(sess){
        renderUser(sess);
        setTab('dashboard');
        showTopLogout(true);
      }
    })();

    // Stats animation
    setInterval(()=>{
      ['ls1','ls2','ls3'].forEach(id=>{
        const el=document.getElementById(id);
        const v=parseInt(el.textContent)||0;
        el.textContent=Math.max(0, v+(Math.random()<0.5?-1:1));
      });
      ['st1','st2','st3'].forEach(id=>{
        const el=document.getElementById(id);
        const v=parseInt(el.textContent)||0;
        el.textContent=Math.max(0, v+(Math.random()<0.5?-1:1));
      });
    }, 25000);
  </script>
</body>
</html>
